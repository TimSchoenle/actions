name: 'Commit Changes'
description: 'Commits changes using the GitHub API to ensure verified bot commits.'

inputs:
  commit_message:
    description: 'The commit message'
    required: true
  token:
    description: 'The GitHub token to use (must be an App installation token for verified commits)'
    required: true
  repository:
    description: 'Repository name to commit to (e.g. owner/repo)'
    required: false
    default: ${{ github.repository }}
  branch:
    description: 'Branch to commit to'
    required: false
    default: ${{ github.head_ref || github.ref_name }}
  empty:
    description: Allow making an empty commit if there are no changes.
    required: false
    default: 'false'
  file_pattern:
    description: 'File pattern to commit'
    required: false
    default: '.'

outputs:
  commit_hash:
    description: 'The SHA of the created commit'
    value: ${{ steps.commit.outputs.commit-hash }}
  commit_url:
    description: 'The URL of the created commit.'
    value: ${{ steps.commit.outputs.commit-url }}
  changes_detected:
    description: 'True if changes were committed'
    value: ${{ steps.compatibility.outputs.changes_detected }}

runs:
  using: 'composite'
  steps:
    - name: Check for Changes
      id: check
      shell: bash
      env:
        FILE_PATTERN: ${{ inputs.file_pattern }}
      # ghcommit seems to struggle with file permissions. This can cause empty commits to be created, even if we disallow it.
      # This is a tmp workaround to prevent this behavior.
      run: |
        # Ignore file permission changes (e.g. chmod +x)
        git config core.fileMode false

        # Treat FILE_PATTERN as a whitespace-separated list of git pathspecs.
        # Examples:
        # - "README.md SECURITY.md"
        # - "actions/**/dist/**/* workflows/**/dist/**/*"
        # - "." (meaning: no filtering / whole repo)
        if [ -z "$FILE_PATTERN" ] || [ "$FILE_PATTERN" = "." ]; then
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "File change detected!"
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No file changes detected!"
          fi
          exit 0
        fi

        read -r -a PATHSPECS <<< "$FILE_PATTERN"

        if [ -n "$(git status --porcelain -- "${PATHSPECS[@]}")" ]; then
          echo "has_changes=true" >> "$GITHUB_OUTPUT"
          echo "File change detected!"
        else
          echo "has_changes=false" >> "$GITHUB_OUTPUT"
          echo "No file changes detected!"
        fi

    - name: Commit Changes
      id: commit
      uses: planetscale/ghcommit-action@25309d8005ac7c3bcd61d3fe19b69e0fe47dbdde # v0.2.20
      if: steps.check.outputs.has_changes == 'true' || inputs.empty == 'true'
      with:
        commit_message: ${{ inputs.commit_message }}
        repo: ${{ inputs.repository }}
        branch: ${{ inputs.branch }}
        empty: ${{ inputs.empty }}
        file_pattern: ${{ inputs.file_pattern }}
      env:
        GITHUB_TOKEN: ${{ inputs.token }}

    - name: Set Compatibility Outputs
      id: compatibility
      shell: bash
      env:
        COMMIT_HASH: ${{ steps.commit.outputs.commit-hash }}
      run: |
        if [ -n "$COMMIT_HASH" ]; then
          echo "changes_detected=true" >> $GITHUB_OUTPUT
        else
          echo "changes_detected=false" >> $GITHUB_OUTPUT
        fi
