name: 'Update Helm Chart Version'
description: 'Updates a Helm chart version/APP tag and creates a PR. 
              This action requires a bot account with access to the charts repo. 
              Requires structure: Chart.yaml (version, appVersion) and values.yaml (image.tag).'
inputs:
  app-id:
    description: 'GitHub App ID'
    required: true
  private-key:
    description: 'GitHub App Private Key'
    required: true
  helm-repo:
    description: 'Repository name of the helm charts (e.g. owner/repo)'
    required: true
  chart-path:
    description: 'Path of the chart inside the repo (e.g. charts/my-app)'
    required: true
  checkout-path:
    description: 'Path to checkout the helm repo to'
    default: 'helm-charts'
    required: false
  new-tag:
    description: 'New app version/tag'
    required: true
  image-digest:
    description: 'Docker image digest (e.g. sha256:...)'
    required: true
  pr-branch-prefix:
    description: 'Prefix for the PR branch'
    default: 'chore/helm/auto-update'
    required: false

outputs:
  pr-url:
    description: 'The URL of the created Pull Request'
    value: ${{ steps.create-pr.outputs.pull-request-url }}

runs:
  using: 'composite'
  steps:
    - name: Parse Inputs
      id: parse
      shell: bash
      run: |
        # Extract chart name from path (basename)
        CHART_NAME=$(basename "${{ inputs.chart-path }}")
        echo "chart-name=$CHART_NAME" >> "$GITHUB_OUTPUT"

        FULL_REPO="${{ inputs.helm-repo }}"
        OWNER="${FULL_REPO%%/*}"
        REPO="${FULL_REPO#*/}"
        echo "owner=$OWNER" >> "$GITHUB_OUTPUT"
        echo "repo=$REPO" >> "$GITHUB_OUTPUT"

    - name: Generate Bot Token
      id: generate_token
      uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
      with:
        app-id: ${{ inputs.app-id }}
        private-key: ${{ inputs.private-key }}
        owner: ${{ steps.parse.outputs.owner }}
        repositories: ${{ steps.parse.outputs.repo }}

    - name: Checkout Helm Charts
      uses: actions/checkout@v6
      with:
        repository: ${{ inputs.helm-repo }}
        token: ${{ steps.generate_token.outputs.token }}
        path: ${{ inputs.checkout-path }}
        fetch-depth: 0

    - name: Get GitHub App User ID
      id: get-user-id
      shell: bash
      env:
        GH_TOKEN: ${{ steps.generate_token.outputs.token }}
      run: echo "user-id=$(gh api "/users/${{ steps.generate_token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"

    - name: Install yq
      uses: dcarbone/install-yq-action@4075b4dca348d74bd83f2bf82d30f25d7c54539b # v1.3.1
      with:
        version: 'v4.44.1'

    - name: Update Chart Version
      id: update-version
      shell: bash
      working-directory: ${{ inputs.checkout-path }}/${{ inputs.chart-path }}
      env:
        NEW_TAG: ${{ inputs.new-tag }}
      run: |
        # Bump patch version
        CURRENT_VERSION=$(yq '.version' Chart.yaml)
        echo "Current Version: $CURRENT_VERSION"

        # Increment patch version (simple awk script)
        NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
        echo "New Version: $NEW_VERSION"
        echo "new-version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

        # Update Chart.yaml
        yq -i ".version = \"$NEW_VERSION\"" Chart.yaml
        yq -i ".appVersion = \"$NEW_TAG\"" Chart.yaml

    - name: Update Image Tag
      shell: bash
      working-directory: ${{ inputs.checkout-path }}/${{ inputs.chart-path }}
      env:
        NEW_TAG: ${{ inputs.new-tag }}
        IMAGE_DIGEST: ${{ inputs.image-digest }}
      run: |
        OLD_TAG_VAL=$(yq '.image.tag' values.yaml)
        echo "Old Tag Value: $OLD_TAG_VAL"
        
        # Construct new tag format: tag@digest
        FULL_TAG="${NEW_TAG}@${IMAGE_DIGEST}"
        echo "New Image Tag: $FULL_TAG"

        # Update values.yaml securely using yq
        yq -i ".image.tag = \"$FULL_TAG\"" values.yaml

    - name: Create Pull Request
      id: create-pr
      uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8
      with:
        token: ${{ steps.generate_token.outputs.token }}
        path: ${{ inputs.checkout-path }}
        branch: ${{ inputs.pr-branch-prefix }}/${{ steps.parse.outputs.chart-name }}/${{ inputs.new-tag }}
        title: 'chore(${{ steps.parse.outputs.chart-name }}): update chart to ${{ steps.update-version.outputs.new-version }}'
        body: |
          Automated update for **${{ steps.parse.outputs.chart-name }}** chart.
          
          - **New Chart Version**: `${{ steps.update-version.outputs.new-version }}`
          - **New App Version**: `${{ inputs.new-tag }}`
          - **Docker Digest**: `${{ inputs.image-digest }}`

          ### Expected Structure
          This action assumes the following structure in the chart directory:
          - `Chart.yaml`: Contains `version` and `appVersion` fields.
          - `values.yaml`: Contains `image.tag` field.
        commit-message: 'chore(${{ steps.parse.outputs.chart-name }}): update chart to ${{ steps.update-version.outputs.new-version }}'
        committer: '${{ steps.generate_token.outputs.app-slug }}[bot] <${{ steps.get-user-id.outputs.user-id }}+${{ steps.generate_token.outputs.app-slug }}[bot]@users.noreply.github.com>'
        author: '${{ steps.generate_token.outputs.app-slug }}[bot] <${{ steps.get-user-id.outputs.user-id }}+${{ steps.generate_token.outputs.app-slug }}[bot]@users.noreply.github.com>'
        delete-branch: true
