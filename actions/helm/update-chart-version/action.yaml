name: 'Update Helm Chart Version'
description: 'Updates a Helm chart version, appVersion, and image tag, then creates a Pull Request.
  This action requires a bot account with access to the charts repo.
  Requires structure: Chart.yaml (version, appVersion) and values.yaml (image.tag).'
inputs:
  app-id:
    description: 'GitHub App ID'
    required: true
  private-key:
    description: 'GitHub App Private Key'
    required: true
  helm-repo:
    description: 'Repository name of the helm charts (e.g. owner/repo)'
    required: true
  chart-path:
    description: 'Path of the chart inside the repo (e.g. charts/my-app)'
    required: true
  checkout-path:
    description: 'Path to checkout the helm repo to'
    default: 'helm-charts'
    required: false
  new-tag:
    description: 'New app version/tag'
    required: true
  image-digest:
    description: 'Docker image digest (e.g. sha256:...)'
    required: true
  pr-branch-prefix:
    description: 'Prefix for the PR branch'
    default: 'chore/helm/auto-update'
    required: false

outputs:
  pr-url:
    description: 'The URL of the created Pull Request'
    value: ${{ steps.create-pr.outputs.pull-request-url }}

runs:
  using: 'composite'
  steps:
    - name: Parse Inputs
      id: parse
      shell: bash
      env:
        CHART_PATH: ${{ inputs.chart-path }}
        HELM_REPO: ${{ inputs.helm-repo }}
      run: |
        # Extract chart name from path (basename)
        CHART_NAME=$(basename "$CHART_PATH")
        echo "chart-name=$CHART_NAME" >> "$GITHUB_OUTPUT"

        FULL_REPO="$HELM_REPO"
        OWNER="${FULL_REPO%%/*}"
        REPO="${FULL_REPO#*/}"
        echo "owner=$OWNER" >> "$GITHUB_OUTPUT"
        echo "repo=$REPO" >> "$GITHUB_OUTPUT"

    - name: Generate Bot Token
      id: generate_token
      uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
      with:
        app-id: ${{ inputs.app-id }}
        private-key: ${{ inputs.private-key }}
        owner: ${{ steps.parse.outputs.owner }}
        repositories: ${{ steps.parse.outputs.repo }}

    - name: Checkout Helm Charts
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
      with:
        repository: ${{ inputs.helm-repo }}
        token: ${{ steps.generate_token.outputs.token }}
        path: ${{ inputs.checkout-path }}
        fetch-depth: 0
        persist-credentials: false

    - name: Get GitHub App User ID
      id: get-user-id
      shell: bash
      env:
        GH_TOKEN: ${{ steps.generate_token.outputs.token }}
        APP_SLUG: ${{ steps.generate_token.outputs.app-slug }}
      run: echo "user-id=$(gh api "/users/${APP_SLUG}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"

    - name: Read Current Version
      id: read-version
      uses: TimSchoenle/actions/actions/common/read-yaml@actions-common-read-yaml-v1.0.2
      with:
        file: ${{ inputs.checkout-path }}/${{ inputs.chart-path }}/Chart.yaml
        key: version

    - name: Calculate New Version
      id: calc-version
      shell: bash
      env:
        CURRENT_VERSION: ${{ steps.read-version.outputs.value }}
      run: |
        # Increment patch version (simple awk script logic)
        NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
        echo "Calculated New Version: $NEW_VERSION"
        echo "new-version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

    - name: Set Chart Version
      uses: TimSchoenle/actions/actions/common/modify-yaml@actions-common-modify-yaml-v1.0.2
      with:
        file: ${{ inputs.checkout-path }}/${{ inputs.chart-path }}/Chart.yaml
        key: version
        value: ${{ steps.calc-version.outputs.new-version }}

    - name: Set App Version
      uses: TimSchoenle/actions/actions/common/modify-yaml@actions-common-modify-yaml-v1.0.2
      with:
        file: ${{ inputs.checkout-path }}/${{ inputs.chart-path }}/Chart.yaml
        key: appVersion
        value: ${{ inputs.new-tag }}

    - name: Construct Full Image Tag
      id: construct-tag
      shell: bash
      env:
        NEW_TAG: ${{ inputs.new-tag }}
        IMAGE_DIGEST: ${{ inputs.image-digest }}
      run: |
        # We need to construct the full tag: TAG@DIGEST
        FULL_TAG="${NEW_TAG}@${IMAGE_DIGEST}"
        echo "Full Tag: $FULL_TAG"
        echo "full-tag=$FULL_TAG" >> "$GITHUB_OUTPUT"

    - name: Update Image Tag
      uses: TimSchoenle/actions/actions/common/modify-yaml@actions-common-modify-yaml-v1.0.2
      with:
        file: ${{ inputs.checkout-path }}/${{ inputs.chart-path }}/values.yaml
        key: image.tag
        value: ${{ steps.construct-tag.outputs.full-tag }}

    - name: Create Pull Request
      id: create-pr
      uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8
      with:
        token: ${{ steps.generate_token.outputs.token }}
        path: ${{ inputs.checkout-path }}
        branch: ${{ inputs.pr-branch-prefix }}/${{ steps.parse.outputs.chart-name }}/${{ inputs.new-tag }}
        title: 'chore(${{ steps.parse.outputs.chart-name }}): update chart to ${{ steps.calc-version.outputs.new-version }}'
        body: |
          Automated update for **${{ steps.parse.outputs.chart-name }}** chart.

          - **New Chart Version**: `${{ steps.calc-version.outputs.new-version }}`
          - **New App Version**: `${{ inputs.new-tag }}`
          - **Docker Digest**: `${{ inputs.image-digest }}`

          ### Expected Structure
          This action assumes the following structure in the chart directory:
          - `Chart.yaml`: Contains `version` and `appVersion` fields.
          - `values.yaml`: Contains `image.tag` field.
        commit-message: 'chore(${{ steps.parse.outputs.chart-name }}): update chart to ${{ steps.calc-version.outputs.new-version }}'
        committer: '${{ steps.generate_token.outputs.app-slug }}[bot] <${{ steps.get-user-id.outputs.user-id }}+${{ steps.generate_token.outputs.app-slug }}[bot]@users.noreply.github.com>'
        author: '${{ steps.generate_token.outputs.app-slug }}[bot] <${{ steps.get-user-id.outputs.user-id }}+${{ steps.generate_token.outputs.app-slug }}[bot]@users.noreply.github.com>'
        delete-branch: true
