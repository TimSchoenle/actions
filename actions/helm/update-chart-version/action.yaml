name: 'Update Helm Chart Version'
description: 'Updates a Helm chart version, appVersion, and image tag, then creates a Pull Request.
  This action requires a bot account with access to the charts repo.
  Requires structure: Chart.yaml (version, appVersion) and values.yaml (image.tag).'
inputs:
  app-id:
    description: 'GitHub App ID'
    required: true
  private-key:
    description: 'GitHub App Private Key'
    required: true
  helm-repo:
    description: 'Repository name of the helm charts (e.g. owner/repo)'
    required: true
  chart-path:
    description: 'Path of the chart inside the repo (e.g. charts/my-app)'
    required: true
  new-tag:
    description: 'New app version/tag'
    required: true
  image-digest:
    description: 'Docker image digest (e.g. sha256:...)'
    required: true
  pr-branch-prefix:
    description: 'Prefix for the PR branch'
    default: 'chore/helm/auto-update'
    required: false

outputs:
  pr-url:
    description: 'The URL of the created Pull Request'
    value: ${{ steps.create-pr.outputs.pr-url }}

runs:
  using: 'composite'
  steps:
    - name: Parse Inputs
      id: parse
      shell: bash
      env:
        CHART_PATH: ${{ inputs.chart-path }}
        HELM_REPO: ${{ inputs.helm-repo }}
      run: |
        # Extract chart name from path (basename)
        CHART_NAME=$(basename "$CHART_PATH")
        echo "chart-name=$CHART_NAME" >> "$GITHUB_OUTPUT"

        FULL_REPO="$HELM_REPO"
        OWNER="${FULL_REPO%%/*}"
        REPO="${FULL_REPO#*/}"
        echo "owner=$OWNER" >> "$GITHUB_OUTPUT"
        echo "repo=$REPO" >> "$GITHUB_OUTPUT"

    - name: Generate Bot Token
      id: generate_token
      uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
      with:
        app-id: ${{ inputs.app-id }}
        private-key: ${{ inputs.private-key }}
        owner: ${{ steps.parse.outputs.owner }}
        repositories: ${{ steps.parse.outputs.repo }}

    - name: Checkout Helm Charts
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      with:
        repository: ${{ inputs.helm-repo }}
        token: ${{ steps.generate_token.outputs.token }}
        fetch-depth: 0
        persist-credentials: false

    - name: Setup App Identity
      id: get-bot-info
      uses: TimSchoenle/actions/actions/common/get-app-git-identity@26754381479003bd81b51fffecc97f1faa20a9bf # actions-common-get-app-git-identity-v1.1.0
      with:
        app-slug: ${{ steps.generate_token.outputs.app-slug }}
        token: ${{ steps.generate_token.outputs.token }}

    - name: Read Current Version
      id: read-version
      uses: TimSchoenle/actions/actions/common/read-yaml@8278a5b0b944ee55bcfa361b60373c803154e3d3 # actions-common-read-yaml-v1.1.0
      with:
        file: ${{ inputs.chart-path }}/Chart.yaml
        key: version

    - name: Calculate New Version
      id: calc-version
      shell: bash
      env:
        CURRENT_VERSION: ${{ steps.read-version.outputs.value }}
      run: |
        # Increment patch version (simple awk script logic)
        NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. '{$NF = $NF + 1;} 1' | sed 's/ /./g')
        echo "Calculated New Version: $NEW_VERSION"
        echo "new-version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

    - name: Set Chart Version
      uses: TimSchoenle/actions/actions/common/modify-yaml@3b93e1f351ca3136ba182e2b4bb50273e9e6ae69 # actions-common-modify-yaml-v1.2.2
      with:
        file: ${{ inputs.chart-path }}/Chart.yaml
        key: version
        value: ${{ steps.calc-version.outputs.new-version }}

    - name: Set App Version
      uses: TimSchoenle/actions/actions/common/modify-yaml@3b93e1f351ca3136ba182e2b4bb50273e9e6ae69 # actions-common-modify-yaml-v1.2.2
      with:
        file: ${{ inputs.chart-path }}/Chart.yaml
        key: appVersion
        value: ${{ inputs.new-tag }}

    - name: Construct Full Image Tag
      id: construct-tag
      shell: bash
      env:
        NEW_TAG: ${{ inputs.new-tag }}
        IMAGE_DIGEST: ${{ inputs.image-digest }}
      run: |
        # We need to construct the full tag: TAG@DIGEST
        FULL_TAG="${NEW_TAG}@${IMAGE_DIGEST}"
        echo "Full Tag: $FULL_TAG"
        echo "full-tag=$FULL_TAG" >> "$GITHUB_OUTPUT"

    - name: Update Image Tag
      uses: TimSchoenle/actions/actions/common/modify-yaml@3b93e1f351ca3136ba182e2b4bb50273e9e6ae69 # actions-common-modify-yaml-v1.2.2
      with:
        file: ${{ inputs.chart-path }}/values.yaml
        key: image.tag
        value: ${{ steps.construct-tag.outputs.full-tag }}

    - name: Calculate Branch Name
      id: branch-name
      shell: bash
      env:
        PREFIX: ${{ inputs.pr-branch-prefix }}
        CHART_NAME: ${{ steps.parse.outputs.chart-name }}
        NEW_TAG: ${{ inputs.new-tag }}
      run: |
        BRANCH="$PREFIX/$CHART_NAME/$NEW_TAG"
        echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"

    - name: Reset Branch
      shell: bash
      env:
        GH_TOKEN: ${{ steps.generate_token.outputs.token }}
        REPO: ${{ inputs.helm-repo }}
        BRANCH: ${{ steps.branch-name.outputs.branch }}
      run: |
        echo "Resetting branch $BRANCH to default branch..."
        # Get default branch SHA
        DEFAULT_BRANCH=$(gh api "/repos/$REPO" --jq .default_branch)
        SHA=$(gh api "/repos/$REPO/git/refs/heads/$DEFAULT_BRANCH" --jq .object.sha)

        # Check if branch exists
        if gh api "/repos/$REPO/git/refs/heads/$BRANCH" > /dev/null 2>&1; then
          # Force update (reset)
          gh api -X PATCH "/repos/$REPO/git/refs/heads/$BRANCH" \
            -f sha="$SHA" \
            -f force=true
          echo "Branch reset to $SHA"
        else
          # Create
          gh api -X POST "/repos/$REPO/git/refs" \
            -f ref="refs/heads/$BRANCH" \
            -f sha="$SHA"
          echo "Branch created at $SHA"
        fi

    - name: Commit Changes
      uses: TimSchoenle/actions/actions/common/commit-changes@85df1583f874da24a2de30e19280e031c25a09c5 # actions-common-commit-changes-v1.1.1
      with:
        token: ${{ steps.generate_token.outputs.token }}
        repository: ${{ inputs.helm-repo }}
        branch: ${{ steps.branch-name.outputs.branch }}
        commit_message: 'chore(${{ steps.parse.outputs.chart-name }}): update chart to ${{ steps.calc-version.outputs.new-version }}'
        file_pattern: '${{ inputs.chart-path }}/Chart.yaml ${{ inputs.chart-path }}/values.yaml'

    - name: Create Pull Request
      id: create-pr
      shell: bash
      env:
        GH_TOKEN: ${{ steps.generate_token.outputs.token }}
        REPO: ${{ inputs.helm-repo }}
        HEAD_BRANCH: ${{ steps.branch-name.outputs.branch }}
        TITLE: 'chore(${{ steps.parse.outputs.chart-name }}): update chart to ${{ steps.calc-version.outputs.new-version }}'
        BODY: |
          Automated update for **${{ steps.parse.outputs.chart-name }}** chart.

          - **New Chart Version**: `${{ steps.calc-version.outputs.new-version }}`
          - **New App Version**: `${{ inputs.new-tag }}`
          - **Docker Digest**: `${{ inputs.image-digest }}`

          ### Expected Structure
          This action assumes the following structure in the chart directory:
          - `Chart.yaml`: Contains `version` and `appVersion` fields.
          - `values.yaml`: Contains `image.tag` field.
      run: |
        PR_URL=$(gh pr create \
          --repo "$REPO" \
          --head "$HEAD_BRANCH" \
          --title "$TITLE" \
          --body "$BODY")
        echo "pr-url=$PR_URL" >> "$GITHUB_OUTPUT"
