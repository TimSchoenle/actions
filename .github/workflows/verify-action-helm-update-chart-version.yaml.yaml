name: Verify Helm Update Chart Version

on:
  push:
    branches:
      - main
    paths:
      - 'actions/helm/update-chart-version/**'
      - '.github/workflows/verify-action-helm-update-chart-version.yaml'
  pull_request:
    branches:
      - main
    paths:
      - 'actions/helm/update-chart-version/**'
      - '.github/workflows/verify-action-helm-update-chart-version.yaml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read # to read content

env:
  TEST_OWNER: TimSchoenle
  TEST_REPO_NAME: actions-testing
  TEST_REPO: TimSchoenle/actions-testing
  TEST_ID: helm-update-test-${{ github.run_number }}-${{ github.run_attempt }}

jobs:
  test-full-update:
    name: 'Test: full chart version update and PR creation'
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test base Branch
        id: base-branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/test-full-update/base/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Create Test Chart Files
        env:
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          set -euo pipefail
          mkdir -p charts/test-app

          cat <<EOF > charts/test-app/Chart.yaml
          apiVersion: v2
          name: test-app
          description: A test chart
          version: 1.2.3
          appVersion: "v0.0.1"
          EOF

          cat <<EOF > charts/test-app/values.yaml
          replicaCount: 1
          image:
            repository: ghcr.io/example/test-app
            tag: "v0.0.1@sha256:olddigest"
            pullPolicy: IfNotPresent
          EOF

      - name: Commit Initial Chart Files
        uses: TimSchoenle/actions/actions/common/commit-changes@8f15b94f827ea2005c0e32cadc86bb50969633dd # actions-common-commit-changes-v1.1.4
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.base-branch.outputs.branch }}
          commit_message: 'test: seed chart files for ${{ env.TEST_ID }}'
          file_pattern: 'charts/test-app/Chart.yaml charts/test-app/values.yaml'

      - name: Run update-chart-version
        id: update
        working-directory: 'update-chart'
        uses: ./tmp/actions-code/actions/helm/update-chart-version
        with:
          app-id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private-key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          helm-repo: ${{ env.TEST_REPO }}
          base_branch: ${{ steps.base-branch.outputs.branch }}
          chart-path: charts/test-app
          new-tag: v2.0.0
          image-digest: sha256:abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890
          pr-branch-prefix: test/helm-update/${{ env.TEST_ID }}

      - name: Verify PR Output
        shell: bash
        env:
          PR_URL: ${{ steps.update.outputs.pr-url }}
        run: |
          set -euo pipefail
          [ -z "$PR_URL" ] && { echo "::error::pr-url output is empty"; exit 1; }
          echo "✅ PR created: $PR_URL"

      - name: Verify Chart.yaml Version Bumped
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          TEST_REPO: ${{ env.TEST_REPO }}
          BRANCH: test/helm-update/${{ env.TEST_ID }}/test-app/v2.0.0
        run: |
          set -euo pipefail
          CHART_CONTENT=$(gh api "/repos/$TEST_REPO/contents/charts/test-app/Chart.yaml?ref=$BRANCH" --jq '.content' | base64 -d)
          echo "Chart.yaml content:"
          echo "$CHART_CONTENT"

          # version should have been bumped from 1.2.3 → 1.2.4
          echo "$CHART_CONTENT" | grep -q "version: 1.2.4" || { echo "::error::Expected version 1.2.4"; exit 1; }
          echo "✅ Chart version bumped to 1.2.4"

      - name: Verify Chart.yaml appVersion Updated
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          TEST_REPO: ${{ env.TEST_REPO }}
          BRANCH: test/helm-update/${{ env.TEST_ID }}/test-app/v2.0.0
        run: |
          set -euo pipefail
          CHART_CONTENT=$(gh api "/repos/$TEST_REPO/contents/charts/test-app/Chart.yaml?ref=$BRANCH" --jq '.content' | base64 -d)
          echo "$CHART_CONTENT" | grep -q "appVersion: v2.0.0" || { echo "::error::Expected appVersion v2.0.0"; exit 1; }
          echo "✅ appVersion set to v2.0.0"

      - name: Verify values.yaml Image Tag Updated
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          TEST_REPO: ${{ env.TEST_REPO }}
          BRANCH: test/helm-update/${{ env.TEST_ID }}/test-app/v2.0.0
        run: |
          set -euo pipefail
          VALUES_CONTENT=$(gh api "/repos/$TEST_REPO/contents/charts/test-app/values.yaml?ref=$BRANCH" --jq '.content' | base64 -d)
          echo "values.yaml content:"
          echo "$VALUES_CONTENT"

          EXPECTED_TAG="v2.0.0@sha256:abcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890"
          echo "$VALUES_CONTENT" | grep -qF "$EXPECTED_TAG" || { echo "::error::Expected image tag '$EXPECTED_TAG'"; exit 1; }
          echo "✅ Image tag set to $EXPECTED_TAG"

      - name: Verify PR Metadata
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          TEST_REPO: ${{ env.TEST_REPO }}
          PR_NUMBER: ${{ steps.update.outputs.pr_number }}
        run: |
          set -euo pipefail
          PR_DATA=$(gh pr view "$PR_NUMBER" --repo "$TEST_REPO" --json title,body,headRefName,files)

          # Verify title contains chart name and new version
          TITLE=$(echo "$PR_DATA" | jq -r '.title')
          echo "$TITLE" | grep -q "test-app" || { echo "::error::PR title missing chart name"; exit 1; }
          echo "$TITLE" | grep -q "1.2.4" || { echo "::error::PR title missing new version"; exit 1; }
          echo "✅ PR title verified: $TITLE"

          # Verify body mentions version details
          BODY=$(echo "$PR_DATA" | jq -r '.body')
          echo "$BODY" | grep -q "1.2.4" || { echo "::error::PR body missing new chart version"; exit 1; }
          echo "$BODY" | grep -q "v2.0.0" || { echo "::error::PR body missing new app version"; exit 1; }
          echo "✅ PR body verified"

          # Verify correct files were changed
          FILES=$(echo "$PR_DATA" | jq -r '.files[].path' | sort)
          echo "Changed files: $FILES"
          echo "$FILES" | grep -q "charts/test-app/Chart.yaml" || { echo "::error::Chart.yaml not in PR"; exit 1; }
          echo "$FILES" | grep -q "charts/test-app/values.yaml" || { echo "::error::values.yaml not in PR"; exit 1; }
          echo "✅ PR files verified"

      - name: Cleanup Base Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.base-branch.outputs.branch }}

      - name: Cleanup PR
        if: always()
        uses: TimSchoenle/actions/actions/common/close-pull-request@d553418def5cd5ba91cf4997752b3e2053fec978 # actions-common-close-pull-request-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          pull_request_id: ${{ steps.update.outputs.pr_number }}

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/helm-update/${{ env.TEST_ID }}/test-app/v2.0.0

  test-custom-branch-prefix:
    name: 'Test: custom PR branch prefix'
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test base Branch
        id: base-branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/test-custom-branch-prefix/base/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Create Test Chart Files
        run: |
          set -euo pipefail
          mkdir -p charts/prefix-app

          cat <<EOF > charts/prefix-app/Chart.yaml
          apiVersion: v2
          name: prefix-app
          version: 0.1.0
          appVersion: "v0.0.1"
          EOF

          cat <<EOF > charts/prefix-app/values.yaml
          image:
            repository: ghcr.io/example/prefix-app
            tag: "v0.0.1@sha256:olddigest"
          EOF

      - name: Commit Initial Chart Files
        uses: TimSchoenle/actions/actions/common/commit-changes@8f15b94f827ea2005c0e32cadc86bb50969633dd # actions-common-commit-changes-v1.1.4
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.base-branch.outputs.branch }}
          commit_message: 'test: seed prefix-app chart for ${{ env.TEST_ID }}'
          file_pattern: 'charts/prefix-app/Chart.yaml charts/prefix-app/values.yaml'

      - name: Run update-chart-version with custom prefix
        id: update
        uses: ./tmp/actions-code/actions/helm/update-chart-version
        with:
          app-id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private-key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          helm-repo: ${{ env.TEST_REPO }}
          base_branch: ${{ steps.base-branch.outputs.branch }}
          chart-path: charts/prefix-app
          new-tag: v3.5.0
          image-digest: sha256:deadbeef1234567890deadbeef1234567890deadbeef1234567890deadbeef12
          pr-branch-prefix: test/custom-prefix/${{ env.TEST_ID }}

      - name: Verify Branch Name Uses Custom Prefix
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          TEST_REPO: ${{ env.TEST_REPO }}
          PR_NUMBER: ${{ steps.update.outputs.pr_number }}
          EXPECTED_BRANCH: test/custom-prefix/${{ env.TEST_ID }}/prefix-app/v3.5.0
        run: |
          set -euo pipefail
          ACTUAL_BRANCH=$(gh pr view "$PR_NUMBER" --repo "$TEST_REPO" --json headRefName --jq '.headRefName')
          [ "$ACTUAL_BRANCH" = "$EXPECTED_BRANCH" ] || { echo "::error::Branch mismatch: expected '$EXPECTED_BRANCH', got '$ACTUAL_BRANCH'"; exit 1; }
          echo "✅ Custom branch prefix verified: $ACTUAL_BRANCH"

      - name: Cleanup Base Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.base-branch.outputs.branch }}

      - name: Cleanup PR
        if: always()
        uses: TimSchoenle/actions/actions/common/close-pull-request@d553418def5cd5ba91cf4997752b3e2053fec978 # actions-common-close-pull-request-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          pull_request_id: ${{ steps.update.outputs.pr_number }}

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/custom-prefix/${{ env.TEST_ID }}/prefix-app/v3.5.0

  test-version-bump:
    name: 'Test Version Bump: ${{ matrix.name }}'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: patch-increment
            initial_version: '2.5.9'
            expected_version: '2.5.10'
            new_tag: v1.0.0-bump1

          - name: zero-patch
            initial_version: '1.0.0'
            expected_version: '1.0.1'
            new_tag: v1.0.0-bump2

          - name: high-numbers
            initial_version: '10.20.99'
            expected_version: '10.20.100'
            new_tag: v1.0.0-bump3

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test base Branch
        id: base-branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/test-version-bump/${{ matrix.name }}/base/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Create Test Chart Files
        env:
          INITIAL_VERSION: ${{ matrix.initial_version }}
        run: |
          set -euo pipefail
          mkdir -p charts/bump-app

          cat <<EOF > charts/bump-app/Chart.yaml
          apiVersion: v2
          name: bump-app
          version: ${INITIAL_VERSION}
          appVersion: "v0.0.0"
          EOF

          cat <<EOF > charts/bump-app/values.yaml
          image:
            repository: ghcr.io/example/bump-app
            tag: "v0.0.0@sha256:placeholder"
          EOF

      - name: Commit Initial Chart Files
        uses: TimSchoenle/actions/actions/common/commit-changes@8f15b94f827ea2005c0e32cadc86bb50969633dd # actions-common-commit-changes-v1.1.4
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.base-branch.outputs.branch }}
          commit_message: 'test: seed bump-app (${{ matrix.name }}) for ${{ env.TEST_ID }}'
          file_pattern: 'charts/bump-app/Chart.yaml charts/bump-app/values.yaml'

      - name: Run update-chart-version
        id: update
        uses: ./tmp/actions-code/actions/helm/update-chart-version
        with:
          app-id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private-key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          helm-repo: ${{ env.TEST_REPO }}
          base_branch: ${{ steps.base-branch.outputs.branch }}
          chart-path: charts/bump-app
          new-tag: ${{ matrix.new_tag }}
          image-digest: sha256:0000000000000000000000000000000000000000000000000000000000000000
          pr-branch-prefix: test/bump/${{ env.TEST_ID }}/${{ matrix.name }}

      - name: Verify Version Bump
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          TEST_REPO: ${{ env.TEST_REPO }}
          BRANCH: test/bump/${{ env.TEST_ID }}/${{ matrix.name }}/bump-app/${{ matrix.new_tag }}
          EXPECTED_VERSION: ${{ matrix.expected_version }}
          NEW_TAG: ${{ matrix.new_tag }}
        run: |
          set -euo pipefail
          CHART_CONTENT=$(gh api "/repos/$TEST_REPO/contents/charts/bump-app/Chart.yaml?ref=$BRANCH" --jq '.content' | base64 -d)
          echo "Chart.yaml:"
          echo "$CHART_CONTENT"

          echo "$CHART_CONTENT" | grep -q "version: $EXPECTED_VERSION" || { echo "::error::Expected version $EXPECTED_VERSION"; exit 1; }
          echo "✅ Version bumped correctly to $EXPECTED_VERSION"

          echo "$CHART_CONTENT" | grep -q "appVersion: $NEW_TAG" || { echo "::error::Expected appVersion $NEW_TAG"; exit 1; }
          echo "✅ appVersion set to $NEW_TAG"

      - name: Cleanup Base Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.base-branch.outputs.branch }}

      - name: Cleanup PR
        if: always()
        uses: TimSchoenle/actions/actions/common/close-pull-request@d553418def5cd5ba91cf4997752b3e2053fec978 # actions-common-close-pull-request-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          pull_request_id: ${{ steps.update.outputs.pr_number }}

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/bump/${{ env.TEST_ID }}/${{ matrix.name }}/bump-app/${{ matrix.new_tag }}

  test-nested-chart-path:
    name: 'Test: nested chart path'
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test base Branch
        id: base-branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/test-nested-chart-path/base/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Create Deeply Nested Chart Files
        run: |
          set -euo pipefail
          mkdir -p infra/k8s/charts/nested-svc

          cat <<EOF > infra/k8s/charts/nested-svc/Chart.yaml
          apiVersion: v2
          name: nested-svc
          version: 3.0.0
          appVersion: "v1.0.0"
          EOF

          cat <<EOF > infra/k8s/charts/nested-svc/values.yaml
          image:
            repository: ghcr.io/example/nested-svc
            tag: "v1.0.0@sha256:old"
          EOF

      - name: Commit Initial Chart Files
        uses: TimSchoenle/actions/actions/common/commit-changes@8f15b94f827ea2005c0e32cadc86bb50969633dd # actions-common-commit-changes-v1.1.4
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.base-branch.outputs.branch }}
          commit_message: 'test: seed nested chart for ${{ env.TEST_ID }}'
          file_pattern: 'infra/k8s/charts/nested-svc/Chart.yaml infra/k8s/charts/nested-svc/values.yaml'

      - name: Run update-chart-version with nested path
        id: update
        uses: ./tmp/actions-code/actions/helm/update-chart-version
        with:
          app-id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private-key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          helm-repo: ${{ env.TEST_REPO }}
          base_branch: ${{ steps.base-branch.outputs.branch }}
          chart-path: infra/k8s/charts/nested-svc
          new-tag: v5.0.0
          image-digest: sha256:nested1234567890nested1234567890nested1234567890nested1234567890
          pr-branch-prefix: test/nested/${{ env.TEST_ID }}

      - name: Verify Nested Chart Updated
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          TEST_REPO: ${{ env.TEST_REPO }}
          BRANCH: test/nested/${{ env.TEST_ID }}/nested-svc/v5.0.0
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          set -euo pipefail

          # Verify Chart.yaml
          CHART_CONTENT=$(gh api "/repos/$TEST_REPO/contents/infra/k8s/charts/nested-svc/Chart.yaml?ref=$BRANCH" --jq '.content' | base64 -d)
          echo "$CHART_CONTENT" | grep -q "version: 3.0.1" || { echo "::error::Expected version 3.0.1"; exit 1; }
          echo "$CHART_CONTENT" | grep -q "appVersion: v5.0.0" || { echo "::error::Expected appVersion v5.0.0"; exit 1; }
          echo "✅ Nested Chart.yaml verified"

          # Verify values.yaml
          VALUES_CONTENT=$(gh api "/repos/$TEST_REPO/contents/infra/k8s/charts/nested-svc/values.yaml?ref=$BRANCH" --jq '.content' | base64 -d)
          echo "$VALUES_CONTENT" | grep -qF "v5.0.0@sha256:nested1234567890nested1234567890nested1234567890nested1234567890" || { echo "::error::Image tag mismatch"; exit 1; }
          echo "✅ Nested values.yaml verified"

          # Verify only the expected files were changed
          PR_NUMBER=$(gh pr list --repo "$TEST_REPO" --head "test/nested/$TEST_ID/nested-svc/v5.0.0" --json number --jq '.[0].number')
          FILES=$(gh pr view "$PR_NUMBER" --repo "$TEST_REPO" --json files --jq '.files[].path' | sort)
          EXPECTED=$(printf '%s\n' "infra/k8s/charts/nested-svc/Chart.yaml" "infra/k8s/charts/nested-svc/values.yaml" | sort)
          [ "$FILES" = "$EXPECTED" ] || { echo "::error::File mismatch. Got: $FILES"; exit 1; }
          echo "✅ Only chart files were changed"

      - name: Cleanup Base Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.base-branch.outputs.branch }}

      - name: Cleanup PR
        if: always()
        uses: TimSchoenle/actions/actions/common/close-pull-request@d553418def5cd5ba91cf4997752b3e2053fec978 # actions-common-close-pull-request-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          pull_request_id: ${{ steps.update.outputs.pr_number }}

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/nested/${{ env.TEST_ID }}/nested-svc/v5.0.0

  test-idempotent-rerun:
    name: 'Test: idempotent re-run resets branch'
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test base Branch
        id: base-branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/test-idempotent-rerun/base/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Create Test Chart Files
        run: |
          set -euo pipefail
          mkdir -p charts/idem-app

          cat <<EOF > charts/idem-app/Chart.yaml
          apiVersion: v2
          name: idem-app
          version: 1.0.0
          appVersion: "v0.0.1"
          EOF

          cat <<EOF > charts/idem-app/values.yaml
          image:
            repository: ghcr.io/example/idem-app
            tag: "v0.0.1@sha256:init"
          EOF

      - name: Commit Initial Chart Files
        uses: TimSchoenle/actions/actions/common/commit-changes@8f15b94f827ea2005c0e32cadc86bb50969633dd # actions-common-commit-changes-v1.1.4
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.base-branch.outputs.branch }}
          commit_message: 'test: seed idem-app for ${{ env.TEST_ID }}'
          file_pattern: 'charts/idem-app/Chart.yaml charts/idem-app/values.yaml'

      - name: First Run
        id: first-run
        uses: ./tmp/actions-code/actions/helm/update-chart-version
        with:
          app-id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private-key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          helm-repo: ${{ env.TEST_REPO }}
          base_branch: ${{ steps.base-branch.outputs.branch }}
          chart-path: charts/idem-app
          new-tag: v9.0.0
          image-digest: sha256:first000000000000000000000000000000000000000000000000000000000000
          pr-branch-prefix: test/idem/${{ env.TEST_ID }}

      - name: Close First PR
        uses: TimSchoenle/actions/actions/common/close-pull-request@d553418def5cd5ba91cf4997752b3e2053fec978 # actions-common-close-pull-request-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          pull_request_id: ${{ steps.first-run.outputs.pr_number }}

      - name: Second Run (same tag, should reset branch and create new PR)
        id: second-run
        uses: ./tmp/actions-code/actions/helm/update-chart-version
        with:
          app-id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private-key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          helm-repo: ${{ env.TEST_REPO }}
          base_branch: ${{ steps.base-branch.outputs.branch }}
          chart-path: charts/idem-app
          new-tag: v9.0.0
          image-digest: sha256:second00000000000000000000000000000000000000000000000000000000000
          pr-branch-prefix: test/idem/${{ env.TEST_ID }}

      - name: Verify Second Run Used Updated Digest
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          TEST_REPO: ${{ env.TEST_REPO }}
          BRANCH: test/idem/${{ env.TEST_ID }}/idem-app/v9.0.0
        run: |
          set -euo pipefail
          VALUES_CONTENT=$(gh api "/repos/$TEST_REPO/contents/charts/idem-app/values.yaml?ref=$BRANCH" --jq '.content' | base64 -d)
          echo "$VALUES_CONTENT"

          # Should contain the SECOND digest, not the first (branch was reset)
          echo "$VALUES_CONTENT" | grep -qF "sha256:second" || { echo "::error::Second digest not found — branch was not reset"; exit 1; }
          echo "$VALUES_CONTENT" | grep -qvF "sha256:first" || { echo "::error::First digest still present — branch was not reset"; exit 1; }
          echo "✅ Branch was correctly reset; second run digest is present"

      - name: Cleanup Base Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.base-branch.outputs.branch }}

      - name: Cleanup PR
        if: always()
        uses: TimSchoenle/actions/actions/common/close-pull-request@d553418def5cd5ba91cf4997752b3e2053fec978 # actions-common-close-pull-request-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          pull_request_id: ${{ steps.second-run.outputs.pr_number }}

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/idem/${{ env.TEST_ID }}/idem-app/v9.0.0
