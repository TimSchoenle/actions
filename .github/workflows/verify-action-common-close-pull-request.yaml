name: Verify Common Close Pull Request

on:
  push:
    branches:
      - main
    paths:
      - 'actions/common/close-pull-request/**'
      - '.github/workflows/verify-action-common-close-pull-request.yaml'
  pull_request:
    branches:
      - main
    paths:
      - 'actions/common/close-pull-request/**'
      - '.github/workflows/verify-action-common-close-pull-request.yaml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read # to read content

env:
  TEST_OWNER: TimSchoenle
  TEST_REPO_NAME: actions-testing
  TEST_REPO: TimSchoenle/actions-testing
  TEST_ID: close-pr-test-${{ github.run_number }}-${{ github.run_attempt }}

jobs:
  test-close-pr:
    name: Test Close PR
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Content
        run: |
          mkdir -p test-close-pr
          echo "Test content for closing PR $TEST_ID" > test-close-pr/file.txt
          date >> test-close-pr/file.txt

      - name: Create PR to Close
        id: create-pr
        uses: TimSchoenle/actions/actions/common/create-pull-request@8a2bdc388cd9c9db8d6dadd44375add3c8885e5d # actions-common-create-pull-request-v1.0.3
        with:
          app-id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private-key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/close-pr/${{ env.TEST_ID }}
          title: '[TEST-CLOSE-PR] To Be Closed - ${{ env.TEST_ID }}'
          body: |
            **Test PR: Close Me**
            This PR is created to test the close-pull-request action.
            Test ID: `${{ env.TEST_ID }}`
          commit_message: 'test: create pr to close (${{ env.TEST_ID }})'
          file_pattern: 'test-close-pr/file.txt'

      - name: Run close-pull-request
        id: test-action
        uses: ./tmp/actions-code/actions/common/close-pull-request
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          pull_request_id: ${{ steps.create-pr.outputs.pr_number }}

      - name: Verify PR Creation
        if: steps.create-pr.outcome == 'failure'
        run: |
          echo "::error::Failed to create PR, cannot proceed with close test"
          exit 1

      - name: Verify PR Closed
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          PR_NUMBER: ${{ steps.create-pr.outputs.pr_number }}
          TEST_REPO: ${{ env.TEST_REPO }}
        run: |
          STATE=$(gh pr view "$PR_NUMBER" --repo "$TEST_REPO" --json state --jq '.state')
          if [ "$STATE" != "CLOSED" ]; then
            echo "::error::PR should be CLOSED, but is $STATE"
            exit 1
          fi
          echo "✅ PR #$PR_NUMBER is successfully CLOSED"

      - name: Verify Output
        if: success()
        env:
          CLOSED_OUTPUT: ${{ steps.test-action.outputs.closed }}
        run: |
          if [ "$CLOSED_OUTPUT" != "true" ]; then
            echo "::error::Output 'closed' should be 'true'"
            exit 1
          fi

      - name: Cleanup Test Artifacts
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: 'test/close-pr/${{ env.TEST_ID }}'

  test-close-pr-not-found:
    name: Test Close Non-Existing PR
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Run close-pull-request (Non-Existing)
        id: test-action
        uses: ./tmp/actions-code/actions/common/close-pull-request
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          pull_request_id: '999999999' # Likely non-existing ID

  test-close-pr-with-comment:
    name: Test Close PR with Custom Comment
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Content
        run: |
          mkdir -p test-close-pr-comment
          echo "Test content for closing PR with comment $TEST_ID" > test-close-pr-comment/file.txt
          date >> test-close-pr-comment/file.txt

      - name: Create PR to Close
        id: create-pr
        uses: TimSchoenle/actions/actions/common/create-pull-request@8a2bdc388cd9c9db8d6dadd44375add3c8885e5d # actions-common-create-pull-request-v1.0.3
        with:
          app-id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private-key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/close-pr-comment/${{ env.TEST_ID }}
          title: '[TEST-CLOSE-PR] To Be Closed with Comment - ${{ env.TEST_ID }}'
          body: |
            **Test PR: Close Me**
            This PR is created to test the close-pull-request action with a custom comment.
            Test ID: `${{ env.TEST_ID }}`
          commit_message: 'test: create pr to close with comment (${{ env.TEST_ID }})'
          file_pattern: 'test-close-pr-comment/file.txt'

      - name: Run close-pull-request
        id: test-action
        uses: ./tmp/actions-code/actions/common/close-pull-request
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          pull_request_id: ${{ steps.create-pr.outputs.pr_number }}
          comment: 'Custom closing comment for ${{ env.TEST_ID }}'

      - name: Verify PR Closed and Comment
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          PR_NUMBER: ${{ steps.create-pr.outputs.pr_number }}
          TEST_REPO: ${{ env.TEST_REPO }}
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          # Verify State
          STATE=$(gh pr view "$PR_NUMBER" --repo "$TEST_REPO" --json state --jq '.state')
          if [ "$STATE" != "CLOSED" ]; then
            echo "::error::PR should be CLOSED, but is $STATE"
            exit 1
          fi

          # Verify Comment
          # We need to fetch comments. gh pr view --json comments includes body of comments.
          COMMENTS=$(gh pr view "$PR_NUMBER" --repo "$TEST_REPO" --json comments --jq '.comments[].body')
          EXPECTED_COMMENT="Custom closing comment for $TEST_ID"

          if ! echo "$COMMENTS" | grep -q "$EXPECTED_COMMENT"; then
            echo "::error::PR comments did not contain expected text: $EXPECTED_COMMENT"
            echo "Actual comments:"
            echo "$COMMENTS"
            exit 1
          fi

          echo "✅ PR #$PR_NUMBER closed with expected comment"

      - name: Cleanup Test Artifacts
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: 'test/close-pr-comment/${{ env.TEST_ID }}'
