name: release-please

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions: {}

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    permissions:
      contents: write # to create release commits and tags
      pull-requests: write # to manage release PRs
    outputs:
      releases_created: ${{ steps.release.outputs.releases_created }}
      paths_released: ${{ steps.release.outputs.paths_released }}
    steps:
      - name: Generate Bot Token
        id: generate_token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.RELEASE_BOT_APP_ID }}
          private-key: ${{ secrets.RELEASE_BOT_PRIVATE_KEY }}

      - name: Run release-please
        id: release
        uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4
        with:
          token: ${{ steps.generate_token.outputs.token }}

  prepare-workflow-matrix:
    name: Prepare Workflow Matrix
    needs: release-please
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    outputs:
      matrix: ${{ steps.check-changes.outputs.matrix }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Check for Manifest Changes
        id: check-changes
        run: |
          # Get previous manifest
          git show HEAD~1:.release-please-manifest.json > prev.json || echo "{}" > prev.json

          # Compare current and previous to find changed keys starting with workflows/
          # output JSON list
          changes=$(jq -n --slurpfile prev prev.json --slurpfile cur .release-please-manifest.json '
            $cur[0] as $c | $prev[0] as $p |
            $c | to_entries | 
            map(select(.key | startswith("workflows/"))) |
            map(select($p[.key] != .value)) |
            map(.key)
          ')

          echo "Detected changes: $changes"
          # Handle empty case
          if [[ "$changes" == "[]" ]]; then
             echo "matrix=[]" >> $GITHUB_OUTPUT
          else
             echo "matrix=$changes" >> $GITHUB_OUTPUT
          fi

  publish-workflow:
    name: Publish Workflow
    needs: [release-please, prepare-workflow-matrix]
    runs-on: ubuntu-latest
    if: ${{ needs.prepare-workflow-matrix.outputs.matrix != '[]' && needs.prepare-workflow-matrix.outputs.matrix != '' }}
    strategy:
      matrix:
        path: ${{ fromJson(needs.prepare-workflow-matrix.outputs.matrix) }}
      fail-fast: false
      max-parallel: 1 # Avoid git race conditions on commit
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout Source
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Need full history for tags/commits
          token: ${{ secrets.GitHub_Token_Action }}

      - name: Generate Bot Token
        id: generate_token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.RELEASE_BOT_APP_ID }}
          private-key: ${{ secrets.RELEASE_BOT_PRIVATE_KEY }}

      - name: Get GitHub App User ID
        id: get-user-id
        shell: bash
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
          APP_SLUG: ${{ steps.generate_token.outputs.app-slug }}
        run: echo "user-id=$(gh api "/users/${APP_SLUG}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"

      - name: Configure Git
        env:
          APP_SLUG: ${{ steps.generate_token.outputs.app-slug }}
          USER_ID: ${{ steps.get-user-id.outputs.user-id }}
        run: |
          git config --global user.name "${APP_SLUG}[bot]"
          git config --global user.email "${USER_ID}+${APP_SLUG}[bot]@users.noreply.github.com"

      - name: Resolve Version
        env:
          WORKFLOW_PATH: ${{ matrix.path }}
        run: |
          path="$WORKFLOW_PATH"
          workflow_name=$(basename "$path")
          normalized_name=$(echo "${path#workflows/}" | tr '/' '-')

          version=$(jq -r --arg key "$path" '.[$key]' .release-please-manifest.json)

          echo "WORKFLOW_NAME=$normalized_name" >> $GITHUB_ENV
          echo "NEW_VERSION=$version" >> $GITHUB_ENV
          echo "TAG_V=workflows/${normalized_name}-v${version}" >> $GITHUB_ENV # Use normalized name for tag!

      - name: Prepare Distribution
        env:
          WORKFLOW_PATH: ${{ matrix.path }}
        run: |
          rm -rf dist
          mkdir -p dist/.github/workflows
          cp -r "$WORKFLOW_PATH/"* dist/

          if [[ -f "dist/workflow.yml" ]]; then
             mv "dist/workflow.yml" "dist/.github/workflows/$WORKFLOW_NAME.yaml"
          elif [[ -f "dist/workflow.yaml" ]]; then
             mv "dist/workflow.yaml" "dist/.github/workflows/$WORKFLOW_NAME.yaml"
          else
             exit 1
          fi

      - name: Commit and Release
        env:
          GITHUB_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          git pull --rebase origin main # Ensure up to date

          mkdir -p .github/workflows
          cp dist/.github/workflows/$WORKFLOW_NAME.yaml .github/workflows/

          git add .github/workflows/$WORKFLOW_NAME.yaml

          # Check if changes exist
          if git diff --staged --quiet; then
             echo "No changes to commit."
          else
             git commit -m "chore(release): publish $WORKFLOW_NAME $NEW_VERSION [skip ci]"
             git push origin main
          fi

          # Tagging
          git tag -f "$TAG_V"
          git push origin -f "$TAG_V"

          # GitHub Release
          if gh release view "$TAG_V" > /dev/null 2>&1; then
             gh release edit "$TAG_V" --title "$WORKFLOW_NAME v$NEW_VERSION" --notes "Release $WORKFLOW_NAME v$NEW_VERSION"
          else
             gh release create "$TAG_V" --title "$WORKFLOW_NAME v$NEW_VERSION" --notes "Release $WORKFLOW_NAME v$NEW_VERSION"
          fi
