name: release-please

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions: {}

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    outputs:
      paths_released: ${{ steps.release.outputs.paths_released }}
    permissions:
      contents: write # to create release commits and tags
      pull-requests: write # to manage release PRs
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Generate Bot Token
        id: generate_token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.RELEASE_BOT_APP_ID }}
          private-key: ${{ secrets.RELEASE_BOT_PRIVATE_KEY }}

      - name: Run release-please
        id: release
        uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4
        with:
          token: ${{ steps.generate_token.outputs.token }}

  prepare-matrix:
    name: Prepare Workflow Matrix
    needs: release-please
    if: always()
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Generate Matrix
        id: set-matrix
        shell: bash
        run: |
          MANIFEST_FILE=".release-please-manifest.json"
          if [ ! -f "$MANIFEST_FILE" ]; then
            echo "::error::Manifest file not found"
            exit 1
          fi

          # Initialize matrix JSON
          MATRIX_JSON="{\"include\":["
          FIRST=true

          # Iterate over workflow packages
          # We use jq to output pipe-delimited lines of "path|version"
          jq -r 'to_entries[] | select(.key | startswith("workflows/")) | "\(.key)|\(.value)"' "$MANIFEST_FILE" | while IFS="|" read -r PKG VERSION; do
            if [ -z "$PKG" ]; then continue; fi
            
            # Derive Component & Tag
            COMPONENT_NAME="workflows-$(echo "$PKG" | cut -d'/' -f2- | tr '/' '-')"
            TAG_NAME="${COMPONENT_NAME}-v${VERSION}"
            
            # Check if tag exists remotely
            if git ls-remote --exit-code --tags origin "refs/tags/$TAG_NAME" >/dev/null 2>&1; then
              echo "Skipping $PKG $VERSION (Tag $TAG_NAME exists)"
            else
              echo "Queueing $PKG $VERSION (Tag $TAG_NAME missing)"
              
              if [ "$FIRST" = true ]; then
                  FIRST=false
              else
                  MATRIX_JSON="${MATRIX_JSON},"
              fi
              
              # Append to JSON
              MATRIX_JSON="${MATRIX_JSON}{\"path\":\"${PKG}\",\"version\":\"${VERSION}\"}"
            fi
          done

          # Close JSON
          MATRIX_JSON="${MATRIX_JSON}]}"

          # Output
          echo "Generated Matrix: $MATRIX_JSON"
          echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT

  publish-workflow:
    name: Publish ${{ matrix.path }}
    needs: prepare-matrix
    if: ${{ needs.prepare-matrix.outputs.matrix != '' && fromJson(needs.prepare-matrix.outputs.matrix).include[0] != null }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Generate Bot Token
        id: generate_token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        with:
          app-id: ${{ secrets.RELEASE_BOT_APP_ID }}
          private-key: ${{ secrets.RELEASE_BOT_PRIVATE_KEY }}
          permission-contents: write
          permission-workflows: write
          permission-pull-requests: write
          permission-metadata: read

      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          token: ${{ steps.generate_token.outputs.token }}
          fetch-depth: 0
          persist-credentials: false

      - name: Configure Git Identity
        env:
          APP_SLUG: ${{ steps.generate_token.outputs.app-slug }}
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
        run: |
          BOT_USERNAME="${APP_SLUG}[bot]"
          BOT_ID=$(gh api "/users/${BOT_USERNAME}" --jq .id)
          BOT_EMAIL="${BOT_ID}+${BOT_USERNAME}@users.noreply.github.com"
          git config user.name "$BOT_USERNAME"
          git config user.email "$BOT_EMAIL"

      - name: Define Variables
        id: vars
        run: |
          PKG="${{ matrix.path }}"
          VERSION="${{ matrix.version }}"
          COMPONENT_NAME="workflows-$(echo "$PKG" | cut -d'/' -f2- | tr '/' '-')"
          TAG_NAME="${COMPONENT_NAME}-v${VERSION}"
          TARGET_FILE="${COMPONENT_NAME#workflows-}.yaml"

          echo "pkg=$PKG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "component_name=$COMPONENT_NAME" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "target_file=$TARGET_FILE" >> $GITHUB_OUTPUT

      - name: Get Release Notes
        id: notes
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
          PKG: ${{ steps.vars.outputs.pkg }}
          VERSION: ${{ steps.vars.outputs.version }}
        run: |
          NOTES="Release $PKG $VERSION"
          CURRENT_SHA=$(git rev-parse HEAD)
          PR_NUMBER=$(gh pr list --search "$CURRENT_SHA" --state merged --json number --jq '.[0].number')

          if [ -n "$PR_NUMBER" ] && [ "$PR_NUMBER" != "null" ]; then
              echo "Found PR #$PR_NUMBER"
              PR_BODY=$(gh pr view "$PR_NUMBER" --json body --jq .body)
              if [ -n "$PR_BODY" ]; then
                # Escape output for multiline strings
                EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
                echo "release_notes<<$EOF" >> $GITHUB_OUTPUT
                echo "$PR_BODY" >> $GITHUB_OUTPUT
                echo "$EOF" >> $GITHUB_OUTPUT
                
                echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
              fi
          fi

          if [ -z "$PR_BODY" ]; then
              echo "release_notes=$NOTES" >> $GITHUB_OUTPUT
          fi

      - name: Prepare Release Branch and Files
        env:
          PKG: ${{ steps.vars.outputs.pkg }}
          COMPONENT_NAME: ${{ steps.vars.outputs.component_name }}
          VERSION: ${{ steps.vars.outputs.version }}
          TARGET_FILE: ${{ steps.vars.outputs.target_file }}
        run: |
          TEMP_BRANCH="temp-release-${COMPONENT_NAME}-${VERSION}"
          echo "Branching to $TEMP_BRANCH"

          # safe extract dir
          mkdir -p /tmp/pkg_content

          # Copy content
          if [ -d "$PKG" ]; then
            cp -r "${PKG}/." /tmp/pkg_content/
          else
            echo "Error: Package directory $PKG does not exist"
            exit 1
          fi

          # Switch branch
          git checkout -b "$TEMP_BRANCH"

          # Clean
          git rm -rf .
          git clean -fdx

          # Distribute Files
          mkdir -p .github/workflows
          shopt -s dotglob
          for FILE in /tmp/pkg_content/*; do
              BASENAME=$(basename "$FILE")
              if [ "$BASENAME" == "README.md" ] || [ "$BASENAME" == "CHANGELOG.md" ]; then
                  cp -r "$FILE" .
              elif [ "$BASENAME" == "workflow.yaml" ]; then
                  cp "$FILE" ".github/workflows/$TARGET_FILE"
              else
                  cp -r "$FILE" .github/workflows/
              fi
          done
          shopt -u dotglob

          # Commit
          git add .
          git commit -m "chore: release $PKG $VERSION"

      - name: Push Tag
        env:
          TAG_NAME: ${{ steps.vars.outputs.tag_name }}
        run: |
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME" -v

      - name: Create Release
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
          TAG_NAME: ${{ steps.vars.outputs.tag_name }}
          COMPONENT_NAME: ${{ steps.vars.outputs.component_name }}
          VERSION: ${{ steps.vars.outputs.version }}
          NOTES: ${{ steps.notes.outputs.release_notes }}
        run: |
          gh release create "$TAG_NAME" --title "${COMPONENT_NAME} ${VERSION}" --notes "$NOTES" -R "${{ github.repository }}"

      - name: Update PR Labels
        if: steps.notes.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
          PR_NUMBER: ${{ steps.notes.outputs.pr_number }}
        run: |
          echo "Updating labels for PR #$PR_NUMBER"
          gh pr edit "$PR_NUMBER" --remove-label "autorelease: pending" --add-label "autorelease: tagged" || echo "Label update failed/skipped"
