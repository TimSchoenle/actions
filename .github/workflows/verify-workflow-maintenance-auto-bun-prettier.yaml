name: Verify Workflow Maintenance Auto Bun Prettier

on:
  push:
    paths:
      - 'workflows/maintenance/auto-bun-prettier/**'
      - '.github/workflows/verify-workflow-maintenance-auto-bun-prettier.yaml'
  pull_request:
    paths:
      - 'workflows/maintenance/auto-bun-prettier/**'
      - '.github/workflows/verify-workflow-maintenance-auto-bun-prettier.yaml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  # =================================================================================
  # ORCHESTRATOR JOB
  # This job runs on the main/PR branch. It sets up a temporary branch and triggers
  # this same workflow on that branch to test the reusable workflow in isolation.
  # =================================================================================
  setup_and_trigger:
    name: Setup & Trigger (Orchestrator)
    if: ${{ !startsWith(github.ref_name, 'ci-test/verify-auto-format-') }}
    runs-on: ubuntu-latest
    permissions:
      contents: write # To push the test branch
      actions: write # To trigger the workflow run
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            github.com:443

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          persist-credentials: false

      - name: Define Branch Name
        id: branch-name
        env:
          RUN_ID: ${{ github.run_id }}
          RUN_ATTEMPT: ${{ github.run_attempt }}
        run: echo "branch=ci-test/verify-auto-format-${RUN_ID}-${RUN_ATTEMPT}" >> "$GITHUB_OUTPUT"

      - name: Create Test Branch and Content
        env:
          BRANCH_NAME: ${{ steps.branch-name.outputs.branch }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Using manual auth to avoid credential persistence in .git/config
          git checkout -b "$BRANCH_NAME"

          # Create an unformatted file
          echo "const    testObj   =    { a:1,    b: 2, c:3}" > unformatted-test-file.ts

          # Basic package.json so the format script works
          echo '{ "scripts": { "format": "prettier --write \"**/*.ts\"" } }' > package.json

          git add unformatted-test-file.ts package.json
          git commit -m "setup: add unformatted file for testing"

          # Construct remote URL securely using env variables to avoid injection
          REMOTE_URL="https://x-access-token:${GH_TOKEN}@github.com/${GH_REPO}.git"
          git push "$REMOTE_URL" "$BRANCH_NAME"

      - name: Trigger Self on Test Branch
        env:
          BRANCH_NAME: ${{ steps.branch-name.outputs.branch }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKFLOW_NAME: ${{ github.workflow }}
        run: |
          echo "üîπ Triggering workflow on $BRANCH_NAME..."
          gh workflow run "$WORKFLOW_NAME" --ref "$BRANCH_NAME"

      - name: Wait for Test Run
        env:
          BRANCH_NAME: ${{ steps.branch-name.outputs.branch }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WORKFLOW_NAME: ${{ github.workflow }}
        run: |
          echo "üîπ Waiting for workflow run on $BRANCH_NAME to complete..."
          sleep 10

          # Use GH CLI to safely find run ID
          RUN_ID=$(gh run list --workflow "$WORKFLOW_NAME" --branch "$BRANCH_NAME" --limit 1 --json databaseId --jq '.[0].databaseId')

          if [[ -z "$RUN_ID" ]]; then
            echo "‚ùå Could not find triggered run on branch $BRANCH_NAME"
            exit 1
          fi

          echo "üîπ Watching run $RUN_ID..."
          gh run watch "$RUN_ID" --exit-status

      - name: Cleanup Test Branch
        if: always()
        env:
          BRANCH_NAME: ${{ steps.branch-name.outputs.branch }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          if [[ -n "$BRANCH_NAME" ]]; then
             REMOTE_URL="https://x-access-token:${GH_TOKEN}@github.com/${GH_REPO}.git"
             git push "$REMOTE_URL" --delete "$BRANCH_NAME" || echo "Branch $BRANCH_NAME already deleted"
          fi

  # =================================================================================
  # WORKER JOBS
  # These jobs ONLY run when the workflow is triggered on the test branch.
  # They function as the actual integration test.
  # =================================================================================
  test_workflow:
    name: Run Auto Format (Worker)
    if: ${{ startsWith(github.ref_name, 'ci-test/verify-auto-format-') }}
    uses: ./workflows/maintenance/auto-bun-prettier/workflow.yaml
    permissions:
      contents: write # Required to commit changes
      pull-requests: write # Required to comment (if PR)
    secrets:
      APP_ID: ${{ secrets.ACTIONS_MAINTENANCE_APP_ID }}
      PRIVATE_KEY: ${{ secrets.ACTIONS_MAINTENANCE_PRIVATE_KEY }}
    with:
      skip_commit: false
      format_command: 'bun add -d prettier && bun run format'

  verify:
    name: Verify Results (Worker)
    if: ${{ startsWith(github.ref_name, 'ci-test/verify-auto-format-') }}
    needs: test_workflow
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            github.com:443

      - name: Checkout Test Branch
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          persist-credentials: false

      - name: Verify Formatting
        run: |
          EXPECTED="const testObj = { a: 1, b: 2, c: 3 };"
          ACTUAL=$(cat unformatted-test-file.ts)

          echo "Expected: $EXPECTED"
          echo "Actual:   $ACTUAL"

          if [[ "$ACTUAL" == *"$EXPECTED"* ]]; then
              echo "‚úÖ Success: File was formatted correctly."
          else
              echo "‚ùå Failure: File was NOT formatted correctly."
              exit 1
          fi
