name: Verify Bun Setup Cached
on:
  push:
    branches: ['main']
    paths:
      - 'actions/bun/setup-cached/**'
      - '.github/workflows/verify-action-bun-setup-cached.yaml'
  pull_request:
    branches: ['main']
    paths:
      - 'actions/bun/setup-cached/**'
      - '.github/workflows/verify-action-bun-setup-cached.yaml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

env:
  TEST_DIR: test-project
  DEP_DIR: unique-dep
  TEST_PKG: unique-dep

jobs:
  prime-cache:
    name: Prime Cache
    runs-on: ubuntu-latest
    outputs:
      seed: ${{ steps.generate.outputs.seed }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            bun.sh:443
            github.com:443
            registry.npmjs.org:443
            release-assets.githubusercontent.com:443

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          persist-credentials: false

      - name: Setup Bun
        uses: oven-sh/setup-bun@b7a1c7ccf290d58743029c4f6903da283811b979 # v2
        with:
          bun-version: latest

      - name: Generate Project
        id: generate
        run: |
          mkdir "$TEST_DIR"
          mkdir "$DEP_DIR"
          SEED=$RANDOM
          echo "seed=$SEED" >> $GITHUB_OUTPUT

          # Create unique dependency package
          echo "{\"name\": \"$TEST_PKG\", \"version\": \"1.0.0-$SEED\"}" > "$DEP_DIR/package.json"

          # Create main package using file dependency
          echo "{\"name\": \"$TEST_DIR\", \"dependencies\": {\"$TEST_PKG\": \"file:../$DEP_DIR\"}}" > "$TEST_DIR/package.json"

      - name: Install Dependencies (Generate Lockfile)
        working-directory: ${{ env.TEST_DIR }}
        run: bun install

      - name: Run Setup Cached (Expect Miss)
        id: setup
        uses: ./actions/bun/setup-cached
        with:
          working-directory: ${{ env.TEST_DIR }}
          cache-key-prefix: 'verify-${{ steps.generate.outputs.seed }}-'

      - name: Verify Cache Miss
        if: steps.setup.outputs.cache-hit == 'true'
        run: |
          echo "::error::Expected cache miss on first run, got hit"
          exit 1

      - name: Verify Outputs
        env:
          CACHE_KEY: ${{ steps.setup.outputs.cache-key }}
        run: |
          echo "Cache Key: $CACHE_KEY"
          if [ -z "$CACHE_KEY" ]; then
            echo "::error::Cache key output is empty"
            exit 1
          fi

  verify-cache:
    name: Verify Cache Hit
    needs: prime-cache
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: block
          allowed-endpoints: >
            api.github.com:443
            bun.sh:443
            github.com:443
            registry.npmjs.org:443
            release-assets.githubusercontent.com:443

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          persist-credentials: false

      - name: Setup Bun
        uses: oven-sh/setup-bun@b7a1c7ccf290d58743029c4f6903da283811b979 # v2
        with:
          bun-version: latest

      - name: Re-Generate Project
        env:
          SEED: ${{ needs.prime-cache.outputs.seed }}
        run: |
          mkdir "$TEST_DIR"
          mkdir "$DEP_DIR"

          # Re-create unique dependency package
          echo "{\"name\": \"$TEST_PKG\", \"version\": \"1.0.0-$SEED\"}" > "$DEP_DIR/package.json"

          # Re-create main package
          echo "{\"name\": \"$TEST_DIR\", \"dependencies\": {\"$TEST_PKG\": \"file:../$DEP_DIR\"}}" > "$TEST_DIR/package.json"

      - name: Generate Lockfile & Clean
        working-directory: ${{ env.TEST_DIR }}
        run: |
          bun install
          rm -rf node_modules

      - name: Run Setup Cached (Expect Hit)
        id: setup
        uses: ./actions/bun/setup-cached
        with:
          working-directory: ${{ env.TEST_DIR }}
          cache-key-prefix: 'verify-${{ needs.prime-cache.outputs.seed }}-'

      - name: Verify Cache Hit
        if: steps.setup.outputs.cache-hit != 'true'
        run: |
          echo "::error::Expected cache hit on second run, got miss"
          exit 1

      - name: Verify Outputs
        env:
          CACHE_KEY: ${{ steps.setup.outputs.cache-key }}
        run: |
          echo "Cache Key: $CACHE_KEY"

      - name: Verify Dependencies
        working-directory: ${{ env.TEST_DIR }}
        run: |
          test -d "node_modules" || (echo "::error::node_modules not restored" && exit 1)
          # Check if the unique dependency is present (it might be symlinked or copied depending on bun)
          test -d "node_modules/$TEST_PKG" || (echo "::error::dependency $TEST_PKG not found" && exit 1)
          echo "Cache restored successfully"
