name: Verify Helper Verify-commit-authors

on:
  push:
    branches:
      - main
    paths:
      - '/actions/helper/verify-commit-authors/**'
      - '.github/workflows/verify-action-helper-verify-commit-authors.yaml'
  pull_request:
    paths:
      - '/actions/helper/verify-commit-authors/**'
      - '.github/workflows/verify-action-helper-verify-commit-authors.yaml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  verify:
    name: Verify Verify-commit-authors
    runs-on: ubuntu-latest
    permissions:
      contents: read # to fetch code
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          persist-credentials: false

      - name: Fetch Current PR Authors
        id: fetch-authors
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          echo "Fetching authors for PR: $PR_URL"

          # shellcheck disable=SC2016
          QUERY='
            query($url: URI!) {
              resource(url: $url) {
                ... on PullRequest {
                  commits(last: 100) {
                    nodes {
                      commit {
                        authors(first: 10) {
                          nodes {
                            user {
                              databaseId
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          '

          # Extract all unique author IDs into a comma-separated string
          AUTHORS=$(gh api graphql -F url="$PR_URL" -f query="$QUERY" | jq -r '
            [
              .data.resource.commits.nodes[].commit.authors.nodes[].user.databaseId 
            ] | unique | join(",")
          ')

          echo "Found Authors: $AUTHORS"
          echo "authors=$AUTHORS" >> "$GITHUB_OUTPUT"

      - name: Test verify-commit-authors (Positive - Should Pass)
        id: test-positive
        uses: ./actions/helper/verify-commit-authors
        with:
          pr_url: ${{ github.event.pull_request.html_url }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          user_ids: ${{ steps.fetch-authors.outputs.authors }}

      - name: Assert Positive Result
        if: steps.test-positive.outputs.verified != 'true'
        env:
          VERIFIED: ${{ steps.test-positive.outputs.verified }}
        run: |
          echo "::error::Positive test failed! Expected verified=true, got $VERIFIED"
          exit 1

      - name: Test verify-commit-authors (Negative - Should Fail)
        id: test-negative
        uses: ./actions/helper/verify-commit-authors
        with:
          pr_url: ${{ github.event.pull_request.html_url }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          user_ids: 1 # Dummy ID

      - name: Assert Negative Result
        if: steps.test-negative.outputs.verified != 'false'
        env:
          VERIFIED: ${{ steps.test-negative.outputs.verified }}
        run: |
          echo "::error::Negative test failed! Expected verified=false, got $VERIFIED"
          exit 1
