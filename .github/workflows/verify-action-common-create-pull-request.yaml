name: Verify Common Create Pull Request

on:
  push:
    branches:
      - main
    paths:
      - 'actions/common/create-pull-request/**'
      - '.github/workflows/verify-action-common-create-pull-request.yaml'
  pull_request:
    branches:
      - main
    paths:
      - 'actions/common/create-pull-request/**'
      - '.github/workflows/verify-action-common-create-pull-request.yaml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read # to read content

env:
  TEST_OWNER: TimSchoenle
  TEST_REPO_NAME: actions-testing
  TEST_REPO: TimSchoenle/actions-testing
  TEST_ID: create-pr-test-${{ github.run_number }}-${{ github.run_attempt }}

jobs:
  test-with-changes:
    name: Test PR Creation with Changes
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test File
        env:
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          mkdir -p test-pr-output
          echo "Test content for $TEST_ID" > test-pr-output/test-file.txt
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> test-pr-output/test-file.txt

      - name: Run create-pull-request (with changes)
        id: create-pr
        uses: ./tmp/actions-code/actions/common/create-pull-request
        with:
          app-id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private-key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/create-pr-with-changes/${{ env.TEST_ID }}
          title: '[TEST-CREATE-PR] With Changes - ${{ env.TEST_ID }}'
          body: |
            **Test PR: Create with Changes**

            This is a test PR created by the create-pull-request action verification workflow.

            - **Test ID**: `${{ env.TEST_ID }}`
            - **Run Number**: `${{ github.run_number }}`
            - **Commit**: `${{ github.sha }}`
            - **Scenario**: Testing PR creation with file changes
          commit_message: 'test: verify create-pull-request action with changes (${{ env.TEST_ID }})'
          file_pattern: 'test-pr-output/test-file.txt'

      - name: Verify PR Created and Content
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          PR_URL: ${{ steps.create-pr.outputs.pr_url }}
          PR_NUMBER: ${{ steps.create-pr.outputs.pr_number }}
          EXPECTED_TITLE: '[TEST-CREATE-PR] With Changes - ${{ env.TEST_ID }}'
          TEST_ID: ${{ env.TEST_ID }}
          TEST_REPO: ${{ env.TEST_REPO }}
        run: |
          if [ -z "$PR_URL" ]; then
            echo "::error::PR URL was not set"
            exit 1
          fi

          if [ -z "$PR_NUMBER" ]; then
            echo "::error::PR number was not set"
            exit 1
          fi

          echo "✅ PR created successfully: $PR_URL"
          echo "PR Number: $PR_NUMBER"

          # Fetch PR details
          PR_DATA=$(gh pr view "$PR_NUMBER" --repo "$TEST_REPO" --json title,body,headRefName,baseRefName,files)

          # Verify title
          ACTUAL_TITLE=$(echo "$PR_DATA" | jq -r '.title')
          if [ "$ACTUAL_TITLE" != "$EXPECTED_TITLE" ]; then
            echo "::error::PR title mismatch. Expected: '$EXPECTED_TITLE', Got: '$ACTUAL_TITLE'"
            exit 1
          fi
          echo "✅ Title verified: $ACTUAL_TITLE"

          # Verify body contains test ID
          BODY=$(echo "$PR_DATA" | jq -r '.body')
          if ! echo "$BODY" | grep -q "$TEST_ID"; then
            echo "::error::PR body does not contain test ID: $TEST_ID"
            exit 1
          fi
          echo "✅ Body contains test ID"

          # Verify branch names
          HEAD_BRANCH=$(echo "$PR_DATA" | jq -r '.headRefName')
          BASE_BRANCH=$(echo "$PR_DATA" | jq -r '.baseRefName')
          EXPECTED_HEAD="test/create-pr-with-changes/$TEST_ID"
          if [ "$HEAD_BRANCH" != "$EXPECTED_HEAD" ]; then
            echo "::error::Head branch mismatch. Expected: '$EXPECTED_HEAD', Got: '$HEAD_BRANCH'"
            exit 1
          fi
          echo "✅ Head branch verified: $HEAD_BRANCH"
          echo "✅ Base branch: $BASE_BRANCH"

          # Verify file changes
          FILES=$(echo "$PR_DATA" | jq -r '.files[].path')
          if ! echo "$FILES" | grep -q "test-pr-output/test-file.txt"; then
            echo "::error::Expected file 'test-pr-output/test-file.txt' not found in PR"
            echo "Files in PR: $FILES"
            exit 1
          fi
          echo "✅ File changes verified"

          # Verify file content
          FILE_CONTENT=$(gh api "/repos/$TEST_REPO/contents/test-pr-output/test-file.txt?ref=$HEAD_BRANCH" --jq '.content' | base64 -d)
          if ! echo "$FILE_CONTENT" | grep -q "$TEST_ID"; then
            echo "::error::File content does not contain test ID"
            exit 1
          fi
          echo "✅ File content verified"

      - name: Cleanup Test Artifacts
        if: always()
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          TEST_REPO: ${{ env.TEST_REPO }}
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          BRANCH_NAME="test/create-pr-with-changes/$TEST_ID"
          echo "Cleaning up branch: $BRANCH_NAME"

          # Close any open PRs for this branch
          PRS=$(gh pr list --repo "$TEST_REPO" --head "$BRANCH_NAME" --json number --jq '.[].number')
          for PR in $PRS; do
            echo "Closing PR #$PR"
            gh pr close "$PR" --repo "$TEST_REPO" --delete-branch --comment "Closed by cleanup workflow" || true
          done

          # Ensure branch is deleted
          echo "Deleting specific branch ref..."
          gh api -X DELETE "repos/$TEST_REPO/git/refs/heads/$BRANCH_NAME" || true

  test-without-changes:
    name: Test PR Skip with Identical Branches
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Run create-pull-request (no changes)
        id: create-pr
        uses: ./tmp/actions-code/actions/common/create-pull-request
        with:
          app-id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private-key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/create-pr-no-changes/${{ env.TEST_ID }}
          title: '[TEST-CREATE-PR] No Changes - ${{ env.TEST_ID }}'
          body: |
            **Test PR: Skip with No Changes**

            This PR should NOT be created because branches are identical.

            - **Test ID**: `${{ env.TEST_ID }}`
          commit_changes: 'false'

      - name: Verify PR Not Created
        shell: bash
        env:
          PR_URL: ${{ steps.create-pr.outputs.pr_url }}
        run: |
          if [ -n "$PR_URL" ]; then
            echo "::error::PR should not have been created for identical branches"
            exit 1
          fi

          echo "✅ PR correctly skipped (branches are identical)"

      - name: Cleanup Test Artifacts
        if: always()
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          TEST_REPO: ${{ env.TEST_REPO }}
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          BRANCH_NAME="test/create-pr-no-changes/$TEST_ID"
          echo "Cleaning up branch: $BRANCH_NAME"

          # Close any open PRs for this branch (should be none, but safe to check)
          PRS=$(gh pr list --repo "$TEST_REPO" --head "$BRANCH_NAME" --json number --jq '.[].number')
          for PR in $PRS; do
            echo "Closing PR #$PR"
            gh pr close "$PR" --repo "$TEST_REPO" --delete-branch --comment "Closed by cleanup workflow" || true
          done

          # Ensure branch is deleted
          echo "Deleting specific branch ref..."
          gh api -X DELETE "repos/$TEST_REPO/git/refs/heads/$BRANCH_NAME" || true

  test-commit-skip:
    name: Test Commit Skip with No Changes
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Run create-pull-request (commit should be skipped)
        id: create-pr
        uses: ./tmp/actions-code/actions/common/create-pull-request
        with:
          app-id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private-key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/create-pr-commit-skip/${{ env.TEST_ID }}
          title: '[TEST-CREATE-PR] Commit Skip - ${{ env.TEST_ID }}'
          body: |
            **Test PR: Commit Skip**

            This PR should NOT be created because there are no changes to commit.

            - **Test ID**: `${{ env.TEST_ID }}`
          commit_message: 'test: this commit should not be created (${{ env.TEST_ID }})'
          commit_changes: 'true'
          empty_commit: 'false'

      - name: Verify No PR Created
        shell: bash
        env:
          PR_URL: ${{ steps.create-pr.outputs.pr_url }}
        run: |
          if [ -n "$PR_URL" ]; then
            echo "::error::PR should not have been created (no commit, no changes)"
            exit 1
          fi

          echo "✅ Commit and PR correctly skipped (no local changes)"

      - name: Cleanup Test Artifacts
        if: always()
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          TEST_REPO: ${{ env.TEST_REPO }}
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          BRANCH_NAME="test/create-pr-commit-skip/$TEST_ID"
          echo "Cleaning up branch: $BRANCH_NAME"

          # Close any open PRs for this branch (should be none, but safe to check)
          PRS=$(gh pr list --repo "$TEST_REPO" --head "$BRANCH_NAME" --json number --jq '.[].number')
          for PR in $PRS; do
            echo "Closing PR #$PR"
            gh pr close "$PR" --repo "$TEST_REPO" --delete-branch --comment "Closed by cleanup workflow" || true
          done

          # Ensure branch is deleted
          echo "Deleting specific branch ref..."
          gh api -X DELETE "repos/$TEST_REPO/git/refs/heads/$BRANCH_NAME" || true

  test-branch-reset:
    name: Test Branch Reset Behavior
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Initial Test File
        env:
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          mkdir -p test-branch-reset
          echo "Initial content for $TEST_ID" > test-branch-reset/initial.txt

      - name: Create First PR (establish branch history)
        id: create-pr-initial
        uses: ./tmp/actions-code/actions/common/create-pull-request
        with:
          app-id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private-key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/create-pr-branch-reset/${{ env.TEST_ID }}
          title: '[TEST-CREATE-PR] Branch Reset Initial - ${{ env.TEST_ID }}'
          body: |
            **Test PR: Branch Reset (Initial)**

            This is the initial PR to establish branch history.

            - **Test ID**: `${{ env.TEST_ID }}`
          commit_message: 'test: initial commit for branch reset test (${{ env.TEST_ID }})'
          file_pattern: 'test-branch-reset/initial.txt'

      - name: Close Initial PR (Keep Branch)
        if: steps.create-pr-initial.outputs.pr_number
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          PR_NUMBER: ${{ steps.create-pr-initial.outputs.pr_number }}
          TEST_REPO: ${{ env.TEST_REPO }}
        run: |
          gh pr close "$PR_NUMBER" --repo "$TEST_REPO" --comment "Closing initial PR, keeping branch for reset test"

      - name: Add More Content to Test File
        run: |
          echo "Second content line" >> test-branch-reset/initial.txt
          echo "This should be reset away" >> test-branch-reset/initial.txt

      - name: Create Second PR with Branch Reset
        id: create-pr-reset
        uses: ./tmp/actions-code/actions/common/create-pull-request
        with:
          app-id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private-key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/create-pr-branch-reset/${{ env.TEST_ID }}
          title: '[TEST-CREATE-PR] Branch Reset Test - ${{ env.TEST_ID }}'
          body: |
            **Test PR: Branch Reset**

            This PR tests that the branch was reset to the base branch.
            The previous commits on this branch should have been discarded.

            - **Test ID**: `${{ env.TEST_ID }}`
            - **Scenario**: Testing branch reset with reset_branch=true (default)
          commit_message: 'test: commit after branch reset (${{ env.TEST_ID }})'
          file_pattern: 'test-branch-reset/initial.txt'
          reset_branch: 'true'

      - name: Verify Branch Was Reset
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          PR_NUMBER: ${{ steps.create-pr-reset.outputs.pr_number }}
          TEST_ID: ${{ env.TEST_ID }}
          TEST_REPO: ${{ env.TEST_REPO }}
        run: |
          if [ -z "$PR_NUMBER" ]; then
            echo "::error::PR was not created after branch reset"
            exit 1
          fi

          echo "✅ PR created after branch reset: $PR_NUMBER"

          # Get the branch name
          BRANCH_NAME="test/create-pr-branch-reset/$TEST_ID"

          # Verify the file content matches what we expect AFTER reset
          FILE_CONTENT=$(gh api "/repos/$TEST_REPO/contents/test-branch-reset/initial.txt?ref=$BRANCH_NAME" --jq '.content' | base64 -d)

          # Count lines in the file - after reset and new commit, should have exactly 3 lines
          LINE_COUNT=$(echo "$FILE_CONTENT" | wc -l)

          if [ "$LINE_COUNT" -ne "3" ]; then
            echo "::error::Expected 3 lines after reset, got $LINE_COUNT"
            echo "File content:"
            echo "$FILE_CONTENT"
            exit 1
          fi

          # Verify content
          if ! echo "$FILE_CONTENT" | grep -q "Second content line"; then
            echo "::error::File should contain updated content after reset"
            exit 1
          fi

          echo "✅ Branch was properly reset - file content verified"

          # Check commit history - should only have commits from base + our new commit
          COMMITS=$(gh api "/repos/$TEST_REPO/pulls/$PR_NUMBER/commits" --jq '.[].commit.message')
          echo "Commits in PR:"
          echo "$COMMITS"

          # Should contain our new commit message
          if ! echo "$COMMITS" | grep -q "commit after branch reset"; then
            echo "::error::New commit not found in PR"
            exit 1
          fi

          echo "✅ Branch reset behavior verified successfully"

      - name: Cleanup Test Artifacts
        if: always()
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          TEST_REPO: ${{ env.TEST_REPO }}
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          BRANCH_NAME="test/create-pr-branch-reset/$TEST_ID"
          echo "Cleaning up branch: $BRANCH_NAME"

          # Close any open PRs for this branch
          PRS=$(gh pr list --repo "$TEST_REPO" --head "$BRANCH_NAME" --json number --jq '.[].number')
          for PR in $PRS; do
            echo "Closing PR #$PR"
            gh pr close "$PR" --repo "$TEST_REPO" --delete-branch --comment "Closed by cleanup workflow" || true
          done

          # Ensure branch is deleted
          echo "Deleting specific branch ref..."
          gh api -X DELETE "repos/$TEST_REPO/git/refs/heads/$BRANCH_NAME" || true
