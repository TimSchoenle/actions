name: 'Maintenance Auto-approve-renovate'
description: 'Reusable workflow to auto approve Renovate PRs, this is useful to auto merge Renovate PRs which have auto-merge enabled.'

on:
  workflow_call:
    inputs:
      user_ids:
        description: 'Comma-separated list of Database IDs of accepted authors (e.g. "29139614, 123456").'
        required: false
        type: string
        default: '29139614'
      ignore_empty_prs:
        description: 'Ignore PRs with 0 changes. Renovate seems to sometimes create multiple lock-files PR without changing anything.'
        required: false
        type: boolean
        default: true
    secrets:
      token:
        description: 'GitHub Token with permission to approve pull requests'
        required: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-auto-approve-renovate
  cancel-in-progress: true

permissions: {}

jobs:
  auto-approve:
    name: Auto-approve PR
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write # to approve PRs
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Check PR Author
        id: check_author
        env:
          PR_AUTHOR_ID: ${{ github.event.pull_request.user.id }}
          ALLOWED_USER_IDS: ${{ inputs.user_ids }}
        run: |
          echo "PR Author ID: $PR_AUTHOR_ID"
          echo "Allowed User IDs: $ALLOWED_USER_IDS"

          match=false
          # Replace commas with spaces to handle mixed delimiters
          # Then iterate over the space-separated list
          for id in ${ALLOWED_USER_IDS//,/ }; do
            if [[ "$id" == "$PR_AUTHOR_ID" ]]; then
              match=true
              break
            fi
          done

          if [[ "$match" != "true" ]]; then
            echo "PR author ID '$PR_AUTHOR_ID' is not in the allowed list. Skipping."
            echo "match=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "match=true" >> "$GITHUB_OUTPUT"

      - name: Check Changes
        id: check_changes
        env:
          GH_TOKEN: ${{ secrets.token }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          IGNORE_ZERO_CHANGES: ${{ inputs.ignore_empty_prs }}
        run: |
          if [[ "$IGNORE_ZERO_CHANGES" != "true" ]]; then
            echo "Skipping check for 0 changes."
            echo "match=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Get the number of changed files
          changed_files=$(gh pr view "$PR_URL" --json files --jq '.files | length')
          echo "Changed files: $changed_files"

          if [[ "$changed_files" -eq 0 ]]; then
            echo "PR has 0 changed files. Ignoring."
            echo "match=false" >> "$GITHUB_OUTPUT"
          else
            echo "PR has changes. Proceeding."
            echo "match=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Verify Commits and Signatures
        id: verify_commits
        if: steps.check_author.outputs.match == 'true' && steps.check_changes.outputs.match == 'true'
        uses: TimSchoenle/actions/actions/helper/verify-commit-authors@c491552dd91a655f309478870cd6c865cf44197a # actions-helper-verify-commit-authors-v1.1.7
        with:
          pr_url: ${{ github.event.pull_request.html_url }}
          github_token: ${{ secrets.token }}
          user_ids: ${{ inputs.user_ids }}

      - name: Auto-approve
        if: steps.verify_commits.outputs.verified == 'true'
        env:
          GH_TOKEN: ${{ secrets.token }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          echo "All checks passed. Approving PR..."
          gh pr review "$PR_URL" --approve --body "Auto-approved by workflow."
