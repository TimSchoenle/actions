name: Verify Common Commit Changes

on:
  push:
    branches:
      - main
    paths:
      - 'actions/common/commit-changes/**'
      - '.github/workflows/verify-action-common-commit-changes.yaml'
  pull_request:
    branches:
      - main
    paths:
      - 'actions/common/commit-changes/**'
      - '.github/workflows/verify-action-common-commit-changes.yaml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read # to read content

env:
  TEST_OWNER: TimSchoenle
  TEST_REPO_NAME: actions-testing
  TEST_REPO: TimSchoenle/actions-testing
  TEST_ID: commit-changes-test-${{ github.run_number }}-${{ github.run_attempt }}

jobs:
  test-commit-file-patterns:
    name: 'Test Commit: ${{ matrix.name }}'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: single-file
            file_pattern: 'test-output/single.txt'
            setup: |
              mkdir -p test-output
              echo "single $TEST_ID" > test-output/single.txt
            expected_files: |
              test-output/single.txt

          - name: multiple-explicit-files
            file_pattern: 'test-output/a.txt test-output/b.md'
            setup: |
              mkdir -p test-output
              echo "a $TEST_ID" > test-output/a.txt
              echo "b $TEST_ID" > test-output/b.md
            expected_files: |
              test-output/a.txt
              test-output/b.md

          - name: single-glob
            file_pattern: 'test-output/*.txt'
            setup: |
              mkdir -p test-output
              echo "glob $TEST_ID" > test-output/glob-match.txt
            expected_files: |
              test-output/glob-match.txt

          - name: deep-glob
            file_pattern: 'actions/**/dist/**/*'
            setup: |
              mkdir -p actions/foo/dist
              echo "deep $TEST_ID" > actions/foo/dist/deep.js
            expected_files: |
              actions/foo/dist/deep.js

          - name: multiple-deep-globs
            file_pattern: 'actions/**/dist/**/* workflows/**/dist/**/*'
            setup: |
              mkdir -p actions/foo/dist workflows/bar/dist
              echo "a $TEST_ID" > actions/foo/dist/a.txt
              echo "b $TEST_ID" > workflows/bar/dist/b.txt
            expected_files: |
              actions/foo/dist/a.txt
              workflows/bar/dist/b.txt

          - name: dot-all
            file_pattern: '.'
            setup: |
              echo "dot-all $TEST_ID" > dot-all-test.txt
            expected_files: |
              dot-all-test.txt

          - name: nested-untracked-dir
            file_pattern: '.'
            setup: |
              mkdir -p new-dir/sub
              echo "nested $TEST_ID" > new-dir/sub/nested.txt
            expected_files: |
              new-dir/sub/nested.txt

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Branch
        id: branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/patterns/${{ matrix.name }}/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Create Test Files
        shell: bash
        env:
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          set -euo pipefail
          ${{ matrix.setup }}

      - name: Run commit-changes
        id: commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: ${{ matrix.name }} ${{ env.TEST_ID }}'
          file_pattern: ${{ matrix.file_pattern }}

      - name: Verify Outputs
        shell: bash
        env:
          COMMIT_SHA: ${{ steps.commit.outputs.commit_hash }}
          COMMIT_URL: ${{ steps.commit.outputs.commit_url }}
          CHANGES_DETECTED: ${{ steps.commit.outputs.changes_detected }}
        run: |
          set -euo pipefail
          [ -z "$COMMIT_SHA" ] && { echo "::error::commit_hash output is empty"; exit 1; }
          [ -z "$COMMIT_URL" ] && { echo "::error::commit_url output is empty"; exit 1; }
          [ "$CHANGES_DETECTED" = "true" ] || { echo "::error::changes_detected should be true"; exit 1; }
          echo "✅ All outputs present"

      - name: Verify Commit Contains Exactly Expected Files
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          COMMIT_SHA: ${{ steps.commit.outputs.commit_hash }}
          TEST_REPO: ${{ env.TEST_REPO }}
          EXPECTED_FILES: ${{ matrix.expected_files }}
        run: |
          set -euo pipefail

          ACTUAL=$(gh api "/repos/$TEST_REPO/commits/$COMMIT_SHA" --jq '.files[].filename' | sort)
          EXPECTED=$(echo "$EXPECTED_FILES" | sed '/^\s*$/d' | sort)

          echo "Actual files:"
          echo "$ACTUAL"
          echo "Expected files:"
          echo "$EXPECTED"

          if [ "$ACTUAL" != "$EXPECTED" ]; then
            echo "::error::File mismatch"
            diff <(echo "$EXPECTED") <(echo "$ACTUAL") || true
            exit 1
          fi
          echo "✅ Commit contains exactly the expected files"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.branch.outputs.branch }}

  test-pattern-excludes-unrelated:
    name: 'Test Pattern: excludes unrelated files'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: include-vs-exclude
            file_pattern: 'include/target.txt'
            setup: |
              mkdir -p include exclude
              echo "target $TEST_ID" > include/target.txt
              echo "noise $TEST_ID"  > exclude/noise.txt
            expected_files: |
              include/target.txt
            forbidden_files: |
              exclude/noise.txt

          - name: glob-excludes-sibling-dirs
            file_pattern: 'src/**/*.ts'
            setup: |
              mkdir -p src/core docs
              echo "code $TEST_ID" > src/core/index.ts
              echo "doc $TEST_ID"  > docs/readme.md
            expected_files: |
              src/core/index.ts
            forbidden_files: |
              docs/readme.md

          - name: parent-path-not-committed
            file_pattern: 'inside/file.txt'
            setup: |
              mkdir -p inside
              echo "inside $TEST_ID"  > inside/file.txt
              echo "outside $TEST_ID" > outside.txt
            expected_files: |
              inside/file.txt
            forbidden_files: |
              outside.txt

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Branch
        id: branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/exclude/${{ matrix.name }}/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Create Test Files
        shell: bash
        env:
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          set -euo pipefail
          ${{ matrix.setup }}

      - name: Run commit-changes
        id: commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: exclude ${{ matrix.name }} ${{ env.TEST_ID }}'
          file_pattern: ${{ matrix.file_pattern }}

      - name: Verify Expected Present and Forbidden Absent
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          COMMIT_SHA: ${{ steps.commit.outputs.commit_hash }}
          TEST_REPO: ${{ env.TEST_REPO }}
          EXPECTED_FILES: ${{ matrix.expected_files }}
          FORBIDDEN_FILES: ${{ matrix.forbidden_files }}
        run: |
          set -euo pipefail
          [ -z "$COMMIT_SHA" ] && { echo "::error::commit_hash is empty"; exit 1; }

          FILES=$(gh api "/repos/$TEST_REPO/commits/$COMMIT_SHA" --jq '.files[].filename' | sort)
          echo "Files in commit:"
          echo "$FILES"

          fail=0
          while IFS= read -r f; do
            [ -z "$f" ] && continue
            echo "$FILES" | grep -Fxq "$f" || { echo "::error::Expected file missing: $f"; fail=1; }
          done <<< "$EXPECTED_FILES"

          while IFS= read -r f; do
            [ -z "$f" ] && continue
            echo "$FILES" | grep -Fxq "$f" && { echo "::error::Forbidden file present: $f"; fail=1; }
          done <<< "$FORBIDDEN_FILES"

          [ "$fail" -ne 0 ] && exit 1
          echo "✅ Correct files committed, forbidden files excluded"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.branch.outputs.branch }}

  # ---------------------------------------------------------------------------
  # File modification (edit existing tracked file)
  # ---------------------------------------------------------------------------
  test-modify-existing-file:
    name: 'Test Modify: existing tracked file'
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Branch
        id: branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/modify-existing/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Create Initial File
        run: |
          mkdir -p test-modify
          echo "version 1" > test-modify/data.txt

      - name: Commit Initial File
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: initial file ${{ env.TEST_ID }}'
          file_pattern: 'test-modify/data.txt'

      - name: Sync Local With Remote
        env:
          BRANCH_NAME: ${{ steps.branch.outputs.branch }}
        run: |
          git fetch --prune origin "+refs/heads/$BRANCH_NAME:refs/remotes/origin/$BRANCH_NAME"
          git reset --hard "origin/$BRANCH_NAME"

      - name: Modify Existing File
        run: echo "version 2" > test-modify/data.txt

      - name: Commit Modified File
        id: commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: modify existing ${{ env.TEST_ID }}'
          file_pattern: 'test-modify/data.txt'

      - name: Verify Modification Committed
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          COMMIT_SHA: ${{ steps.commit.outputs.commit_hash }}
          TEST_REPO: ${{ env.TEST_REPO }}
        run: |
          set -euo pipefail
          [ -z "$COMMIT_SHA" ] && { echo "::error::Commit not created"; exit 1; }

          STATUS=$(gh api "/repos/$TEST_REPO/commits/$COMMIT_SHA" --jq '.files[] | select(.filename=="test-modify/data.txt") | .status')
          [ "$STATUS" = "modified" ] || { echo "::error::Expected status 'modified', got '$STATUS'"; exit 1; }
          echo "✅ Existing file modification committed correctly"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.branch.outputs.branch }}

  test-file-deletion:
    name: 'Test Delete: tracked file removal'
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Branch
        id: branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/file-deletion/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Create File to Delete
        run: |
          mkdir -p test-delete
          echo "to be deleted" > test-delete/doomed.txt

      - name: Commit Initial File
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: create file for deletion ${{ env.TEST_ID }}'
          file_pattern: 'test-delete/doomed.txt'

      - name: Sync Local With Remote
        env:
          BRANCH_NAME: ${{ steps.branch.outputs.branch }}
        run: |
          git fetch --prune origin "+refs/heads/$BRANCH_NAME:refs/remotes/origin/$BRANCH_NAME"
          git reset --hard "origin/$BRANCH_NAME"

      - name: Delete the File
        run: |
          rm test-delete/doomed.txt
          git status

      - name: Commit Deletion
        id: commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: delete file ${{ env.TEST_ID }}'
          file_pattern: 'test-delete/doomed.txt'

      - name: Verify Deletion Committed
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          COMMIT_SHA: ${{ steps.commit.outputs.commit_hash }}
          TEST_REPO: ${{ env.TEST_REPO }}
        run: |
          set -euo pipefail
          [ -z "$COMMIT_SHA" ] && { echo "::error::Commit not created for deletion"; exit 1; }

          STATUS=$(gh api "/repos/$TEST_REPO/commits/$COMMIT_SHA" --jq '.files[] | select(.filename=="test-delete/doomed.txt") | .status')
          [ "$STATUS" = "removed" ] || { echo "::error::Expected status 'removed', got '$STATUS'"; exit 1; }
          echo "✅ File deletion committed correctly"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.branch.outputs.branch }}

  test-no-commit-scenarios:
    name: 'Test No-Commit: ${{ matrix.name }}'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: empty-disallowed
            file_pattern: '.'
            empty: 'false'
            setup: ''

          - name: empty-dir-only
            file_pattern: '.'
            empty: 'false'
            setup: mkdir -p empty-dir/subdir

          - name: pattern-mismatch
            file_pattern: 'does-not-exist/**/*.txt'
            empty: 'false'
            setup: |
              mkdir -p mismatch
              echo "noise" > mismatch/outside.txt

          - name: chmod-only
            file_pattern: '.'
            empty: 'false'
            setup: __CHMOD_SCENARIO__

          - name: gitignored-file-only
            file_pattern: '.'
            empty: 'false'
            setup: |
              mkdir -p ignored
              echo "ignored/secret.txt" >> .git/info/exclude
              echo "SECRET" > ignored/secret.txt

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Branch
        id: branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/no-commit/${{ matrix.name }}/${{ env.TEST_ID }}
          reset_branch: 'true'

      # chmod scenario needs an initial committed file, then permission change
      - name: 'Setup: create tracked file for chmod test'
        if: matrix.name == 'chmod-only'
        run: |
          mkdir -p test-chmod
          echo "echo hello" > test-chmod/script.sh

      - name: 'Setup: commit initial file for chmod test'
        if: matrix.name == 'chmod-only'
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: chmod setup ${{ env.TEST_ID }}'
          file_pattern: 'test-chmod/script.sh'

      - name: 'Setup: sync after initial commit for chmod test'
        if: matrix.name == 'chmod-only'
        env:
          BRANCH_NAME: ${{ steps.branch.outputs.branch }}
        run: |
          git fetch --prune origin "+refs/heads/$BRANCH_NAME:refs/remotes/origin/$BRANCH_NAME"
          git reset --hard "origin/$BRANCH_NAME"

      - name: 'Setup: apply chmod'
        if: matrix.name == 'chmod-only'
        run: chmod +x test-chmod/script.sh

      - name: Prepare Test Scenario
        if: matrix.setup != '' && matrix.setup != '__CHMOD_SCENARIO__'
        shell: bash
        env:
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          set -euo pipefail          
          ${{ matrix.setup }}

      - name: Run commit-changes (expect no commit)
        id: commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: no-commit ${{ matrix.name }} ${{ env.TEST_ID }}'
          file_pattern: ${{ matrix.file_pattern }}
          empty: ${{ matrix.empty }}

      - name: Verify No Commit Was Created
        shell: bash
        env:
          COMMIT_SHA: ${{ steps.commit.outputs.commit_hash }}
          CHANGES_DETECTED: ${{ steps.commit.outputs.changes_detected }}
        run: |
          set -euo pipefail
          [ "$CHANGES_DETECTED" = "true" ] && { echo "::error::changes_detected should be false"; exit 1; }
          [ -n "${COMMIT_SHA:-}" ] && { echo "::error::commit_hash should be empty"; exit 1; }
          echo "✅ No commit created as expected (${{ matrix.name }})"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.branch.outputs.branch }}

  test-empty-commit-allowed:
    name: 'Test Empty: allowed empty commit'
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Branch
        id: branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/empty-allowed/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Run commit-changes (empty=true, no file changes)
        id: commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: empty commit ${{ env.TEST_ID }}'
          empty: 'true'

      - name: Verify Empty Commit
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          COMMIT_SHA: ${{ steps.commit.outputs.commit_hash }}
          CHANGES_DETECTED: ${{ steps.commit.outputs.changes_detected }}
          TEST_REPO: ${{ env.TEST_REPO }}
        run: |
          set -euo pipefail
          [ "$CHANGES_DETECTED" = "true" ] || { echo "::error::changes_detected should be true"; exit 1; }
          [ -z "$COMMIT_SHA" ] && { echo "::error::commit_hash should not be empty"; exit 1; }

          FILE_COUNT=$(gh api "/repos/$TEST_REPO/commits/$COMMIT_SHA" --jq '.files | length')
          [ "$FILE_COUNT" -eq 0 ] || { echo "::error::Expected 0 files, got $FILE_COUNT"; exit 1; }
          echo "✅ Empty commit created with 0 file changes"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.branch.outputs.branch }}

  test-custom-branch:
    name: 'Test Branch: commit lands on target branch'
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Branch
        id: branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/custom-branch/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Create Test File
        env:
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          mkdir -p test-branch
          echo "branch test $TEST_ID" > test-branch/file.txt

      - name: Run commit-changes
        id: commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: custom branch ${{ env.TEST_ID }}'
          file_pattern: 'test-branch/file.txt'

      - name: Verify Commit Is Branch Tip
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          COMMIT_SHA: ${{ steps.commit.outputs.commit_hash }}
          TEST_REPO: ${{ env.TEST_REPO }}
          BRANCH_NAME: ${{ steps.branch.outputs.branch }}
        run: |
          set -euo pipefail
          [ -z "$COMMIT_SHA" ] && { echo "::error::Commit not created"; exit 1; }

          BRANCH_TIP=$(gh api "/repos/$TEST_REPO/commits/$BRANCH_NAME" --jq '.sha')
          [ "$COMMIT_SHA" = "$BRANCH_TIP" ] || { echo "::error::Commit $COMMIT_SHA is not branch tip ($BRANCH_TIP)"; exit 1; }
          echo "✅ Commit is the tip of branch $BRANCH_NAME"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.branch.outputs.branch }}

  test-commit-message:
    name: 'Test Message: commit message matches input'
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Branch
        id: branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/commit-message/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Create Test File
        env:
          TEST_ID: ${{ env.TEST_ID }}
        run: echo "msg test $TEST_ID" > message-test.txt

      - name: Run commit-changes
        id: commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'chore(test): verify commit message ${{ env.TEST_ID }}'
          file_pattern: 'message-test.txt'

      - name: Verify Commit Message
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          COMMIT_SHA: ${{ steps.commit.outputs.commit_hash }}
          TEST_REPO: ${{ env.TEST_REPO }}
          EXPECTED_MSG: 'chore(test): verify commit message ${{ env.TEST_ID }}'
        run: |
          set -euo pipefail
          [ -z "$COMMIT_SHA" ] && { echo "::error::Commit not created"; exit 1; }

          ACTUAL_MSG=$(gh api "/repos/$TEST_REPO/git/commits/$COMMIT_SHA" --jq '.message')
          [ "$ACTUAL_MSG" = "$EXPECTED_MSG" ] || { echo "::error::Message mismatch: expected '$EXPECTED_MSG', got '$ACTUAL_MSG'"; exit 1; }
          echo "✅ Commit message matches input"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.branch.outputs.branch }}
