name: Verify Common Commit Changes

on:
  push:
    branches:
      - main
    paths:
      - 'actions/common/commit-changes/**'
      - '.github/workflows/verify-action-common-commit-changes.yaml'
  pull_request:
    branches:
      - main
    paths:
      - 'actions/common/commit-changes/**'
      - '.github/workflows/verify-action-common-commit-changes.yaml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read # to read content

env:
  TEST_OWNER: TimSchoenle
  TEST_REPO_NAME: actions-testing
  TEST_REPO: TimSchoenle/actions-testing
  TEST_ID: commit-changes-test-${{ github.run_number }}-${{ github.run_attempt }}

jobs:
  test-basic-commit:
    name: Test Basic Commit
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Branch
        id: branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/basic-commit/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Create Test File
        env:
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          mkdir -p test-output
          echo "Test content for basic commit $TEST_ID" > test-output/basic-commit.txt

      - name: Run commit-changes (Basic)
        id: commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: basic commit ${{ env.TEST_ID }}'
          file_pattern: 'test-output/basic-commit.txt'

      - name: Verify Commit
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          COMMIT_SHA: ${{ steps.commit.outputs.commit_hash }}
          TEST_REPO: ${{ env.TEST_REPO }}
          EXPECTED_MSG: 'test: basic commit ${{ env.TEST_ID }}'
        run: |
          if [ -z "$COMMIT_SHA" ]; then
            echo "::error::Commit SHA not found in output"
            exit 1
          fi

          echo "✅ Commit created: $COMMIT_SHA"

          # Verify commit message
          MSG=$(gh api "/repos/$TEST_REPO/git/commits/$COMMIT_SHA" --jq '.message')
          if [ "$MSG" != "$EXPECTED_MSG" ]; then
            echo "::error::Commit message mismatch. Expected '$EXPECTED_MSG', got '$MSG'"
            exit 1
          fi
          echo "✅ Commit message verified"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.branch.outputs.branch }}

  test-file-pattern-multiple-files:
    name: Test File Pattern Variants (${{ matrix.name }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: multiple-files-list
            file_pattern: 'test-output/README.md test-output/SECURITY.md'
            expected_files: |
              test-output/README.md
              test-output/SECURITY.md
          - name: multiple-globs
            file_pattern: 'actions/**/dist/**/* workflows/**/dist/**/*'
            expected_files: |
              actions/foo/dist/a.txt
              workflows/bar/dist/b.txt
          - name: dot-all
            file_pattern: '.'
            expected_files: |
              dot-all.txt

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Branch
        id: branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/file-pattern-matrix/${{ env.TEST_ID }}/${{ matrix.name }}
          reset_branch: 'true'

      - name: Create Test Files for Pattern
        shell: bash
        env:
          TEST_ID: ${{ env.TEST_ID }}
          CASE: ${{ matrix.name }}
        run: |
          set -euo pipefail

          if [ "$CASE" = "multiple-files-list" ]; then
            mkdir -p test-output
            echo "README $TEST_ID" > test-output/README.md
            echo "SECURITY $TEST_ID" > test-output/SECURITY.md
          elif [ "$CASE" = "multiple-globs" ]; then
            mkdir -p actions/foo/dist
            mkdir -p workflows/bar/dist
            echo "actions dist $TEST_ID" > actions/foo/dist/a.txt
            echo "workflows dist $TEST_ID" > workflows/bar/dist/b.txt
          elif [ "$CASE" = "dot-all" ]; then
            echo "dot all $TEST_ID" > dot-all.txt
          else
            echo "::error::Unknown matrix case: $CASE"
            exit 1
          fi

      - name: Run commit-changes
        id: commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: file pattern matrix (${{ matrix.name }}) ${{ env.TEST_ID }}'
          file_pattern: ${{ matrix.file_pattern }}

      - name: Verify Commit Includes Expected Files (and nothing else)
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          COMMIT_SHA: ${{ steps.commit.outputs.commit_hash }}
          TEST_REPO: ${{ env.TEST_REPO }}
          EXPECTED_FILES: ${{ matrix.expected_files }}
        run: |
          set -euo pipefail

          if [ -z "$COMMIT_SHA" ]; then
            echo "::error::Commit SHA not found in output"
            exit 1
          fi

          FILES=$(gh api "/repos/$TEST_REPO/commits/$COMMIT_SHA" --jq '.files[].filename' | sort || true)
          EXPECTED_SORTED=$(printf '%s\n' "$EXPECTED_FILES" | sed '/^\s*$/d' | sort)

          echo "Files in commit:"
          echo "$FILES"
          echo "Expected files:"
          echo "$EXPECTED_SORTED"

          # Missing expected files?
          missing=0
          while IFS= read -r f; do
            [ -z "$f" ] && continue
            if ! echo "$FILES" | grep -Fxq "$f"; then
              echo "::error::Expected file missing from commit: $f"
              missing=1
            fi
          done <<< "$EXPECTED_SORTED"

          # Unexpected extra files?
          extra=0
          while IFS= read -r f; do
            [ -z "$f" ] && continue
            if ! echo "$EXPECTED_SORTED" | grep -Fxq "$f"; then
              echo "::error::Unexpected file present in commit: $f"
              extra=1
            fi
          done <<< "$FILES"

          if [ "$missing" -ne 0 ] || [ "$extra" -ne 0 ]; then
            exit 1
          fi

          echo "✅ Expected files verified (no extras)"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.branch.outputs.branch }}

  test-empty-commit-allowed:
    name: Test Empty Commit (Allowed)
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Branch
        id: branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/empty-commit-allowed/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Run commit-changes (Empty Allowed)
        id: commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: empty commit allowed ${{ env.TEST_ID }}'
          empty: 'true'

      - name: Verify Empty Commit
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          COMMIT_SHA: ${{ steps.commit.outputs.commit_hash }}
          CHANGES_DETECTED: ${{ steps.commit.outputs.changes_detected }}
          TEST_REPO: ${{ env.TEST_REPO }}
        run: |
          set -euo pipefail

          if [ "$CHANGES_DETECTED" != "true" ]; then
            echo "::error::changes_detected should be true for allowed empty commit"
            exit 1
          fi

          if [ -z "$COMMIT_SHA" ]; then
            echo "::error::Commit SHA not found for empty commit"
            exit 1
          fi

          # Empty commit must not include any file changes
          COUNT=$(gh api "/repos/$TEST_REPO/commits/$COMMIT_SHA" --jq '.files | length')
          if [ "$COUNT" -ne 0 ]; then
            FILES=$(gh api "/repos/$TEST_REPO/commits/$COMMIT_SHA" --jq '.files[].filename' || true)
            echo "::error::Expected empty commit (0 files), got $COUNT files:"
            echo "$FILES"
            exit 1
          fi

          echo "✅ Empty commit created successfully (0 files changed)"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.branch.outputs.branch }}

  test-empty-commit-disallowed:
    name: Test Empty Commit (Disallowed)
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Branch
        id: branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/empty-commit-disallowed/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Run commit-changes (Empty Disallowed)
        id: commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: empty commit disallowed ${{ env.TEST_ID }}'
          empty: 'false'

      - name: Verify No Commit
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          COMMIT_SHA: ${{ steps.commit.outputs.commit_hash }}
          CHANGES_DETECTED: ${{ steps.commit.outputs.changes_detected }}
        run: |
          if [ "$CHANGES_DETECTED" == "true" ]; then
             echo "::error::Changes detected should be false for disallowed empty commit"
             exit 1
          fi

          if [ -n "$COMMIT_SHA" ]; then
            echo "::error::Commit SHA should be empty when no commit is created"
            exit 1
          fi

          echo "✅ No commit created as expected"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.branch.outputs.branch }}

  test-file-pattern:
    name: Test File Pattern
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Branch
        id: branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/file-pattern/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Create Test Files
        env:
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          mkdir -p test-pattern
          echo "Included file $TEST_ID" > test-pattern/included.txt
          echo "Ignored file $TEST_ID" > test-pattern/ignored.txt

      - name: Run commit-changes (Pattern)
        id: commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: file pattern ${{ env.TEST_ID }}'
          file_pattern: 'test-pattern/included.txt'

      - name: Verify File Pattern
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          COMMIT_SHA: ${{ steps.commit.outputs.commit_hash }}
          TEST_REPO: ${{ env.TEST_REPO }}
        run: |
          if [ -z "$COMMIT_SHA" ]; then
            echo "::error::Commit not created"
            exit 1
          fi

          # List files in commit
          FILES=$(gh api "/repos/$TEST_REPO/commits/$COMMIT_SHA" --jq '.files[].filename')

          if ! echo "$FILES" | grep -q "test-pattern/included.txt"; then
             echo "::error::Included file missing from commit"
             exit 1
          fi

          if echo "$FILES" | grep -q "test-pattern/ignored.txt"; then
             echo "::error::Ignored file present in commit"
             exit 1
          fi

          echo "✅ File pattern verified correctly"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.branch.outputs.branch }}}

  test-chmod-ignored:
    name: Test CHMOD Changes Ignored
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Branch
        id: branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/chmod-ignored/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Setup Initial State
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          TEST_REPO: ${{ env.TEST_REPO }}
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          mkdir -p test-chmod
          echo "echo 'hello'" > test-chmod/script.sh

      - name: Create Initial Commit
        id: initial_commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: initial setup ${{ env.TEST_ID }}'
          file_pattern: 'test-chmod/script.sh'

      - name: Reset to Initial State(The commit action is using the github API to commit changes, so the local git state is out of sync with the remote)
        env:
          BRANCH_NAME: ${{ steps.branch.outputs.branch }}
        run: |
          git fetch --prune origin "+refs/heads/$BRANCH_NAME:refs/remotes/origin/$BRANCH_NAME"
          git reset --hard "origin/$BRANCH_NAME"

      - name: Change Permissions
        run: |
          chmod +x test-chmod/script.sh
          # Verify local change exists
          ls -l test-chmod/script.sh

      - name: Run commit-changes (Should Ignore Chmod)
        id: commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: chmod change ${{ env.TEST_ID }}'
          file_pattern: 'test-chmod/script.sh'
          empty: 'false'

      - name: Verify No Commit
        shell: bash
        env:
          CHANGES_DETECTED: ${{ steps.commit.outputs.changes_detected }}
        run: |
          if [ "$CHANGES_DETECTED" == "true" ]; then
             echo "::error::Changes detected for chmod only change - should be ignored"
             exit 1
          fi
          echo "✅ Chmod only change correctly ignored"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.branch.outputs.branch }}

  test-existing-file:
    name: Test Existing File
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Branch
        id: branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/existing-file/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Setup Initial State
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          TEST_REPO: ${{ env.TEST_REPO }}
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          mkdir -p test-chmod
          echo "echo 'hello'" > test-chmod/script.sh

      - name: Create Initial Commit
        id: initial_commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: initial setup ${{ env.TEST_ID }}'
          file_pattern: 'test-chmod/script.sh'

      - name: Reset to Initial State(The commit action is using the github API to commit changes, so the local git state is out of sync with the remote)
        env:
          BRANCH_NAME: ${{ steps.branch.outputs.branch }}
        run: |
          git fetch --prune origin "+refs/heads/$BRANCH_NAME:refs/remotes/origin/$BRANCH_NAME"
          git reset --hard "origin/$BRANCH_NAME"

      - name: Change File content
        run: |
          mkdir -p test-chmod
          echo "echo 'hello2'" > test-chmod/script.sh

      - name: Run commit-changes
        id: commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: chmod change ${{ env.TEST_ID }}'
          file_pattern: 'test-chmod/script.sh'
          empty: 'false'

      - name: Verify Commit
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          COMMIT_SHA: ${{ steps.commit.outputs.commit_hash }}
          TEST_REPO: ${{ env.TEST_REPO }}
          EXPECTED_MSG: 'test: chmod change ${{ env.TEST_ID }}'
        run: |
          if [ -z "$COMMIT_SHA" ]; then
            echo "::error::Commit SHA not found in output"
            exit 1
          fi

          echo "✅ Commit created: $COMMIT_SHA"

          # Verify commit message
          MSG=$(gh api "/repos/$TEST_REPO/git/commits/$COMMIT_SHA" --jq '.message')
          if [ "$MSG" != "$EXPECTED_MSG" ]; then
            echo "::error::Commit message mismatch. Expected '$EXPECTED_MSG', got '$MSG'"
            exit 1
          fi
          echo "✅ Commit message verified"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.branch.outputs.branch }}

  test-custom-branch:
    name: Test Custom Branch
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Branch
        id: branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/custom-branch/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Create Test File
        env:
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          mkdir -p test-custom
          echo "Custom branch content $TEST_ID" > test-custom/file.txt

      - name: Run commit-changes (Custom Branch)
        id: commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: custom branch commit ${{ env.TEST_ID }}'
          file_pattern: 'test-custom/file.txt'

      - name: Verify Custom Branch Commit
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          COMMIT_SHA: ${{ steps.commit.outputs.commit_hash }}
          TEST_REPO: ${{ env.TEST_REPO }}
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          if [ -z "$COMMIT_SHA" ]; then
            echo "::error::Commit not created"
            exit 1
          fi

          # Verify commit exists on the correct branch
          BRANCH_NAME="test/custom-branch/$TEST_ID"
          BRANCH_SHA=$(gh api "/repos/$TEST_REPO/commits/$BRANCH_NAME" --jq '.sha')

          if [ "$COMMIT_SHA" != "$BRANCH_SHA" ]; then
             echo "::error::Commit SHA does not match branch tip. Got $BRANCH_SHA, expected $COMMIT_SHA"
             exit 1
          fi

          echo "✅ Commit verified on custom branch: $BRANCH_NAME"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.branch.outputs.branch }}

  test-empty-directory-only:
    name: Test Empty Directory Only (should NOT commit)
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Branch
        id: branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/empty-dir-only/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Create Empty Directory
        run: |
          mkdir -p empty-dir-only/subdir

      - name: Run commit-changes (should not commit)
        id: commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: empty dir only ${{ env.TEST_ID }}'
          file_pattern: '.'
          empty: 'false'

      - name: Verify No Commit
        shell: bash
        env:
          COMMIT_SHA: ${{ steps.commit.outputs.commit_hash }}
          CHANGES_DETECTED: ${{ steps.commit.outputs.changes_detected }}
        run: |
          if [ "$CHANGES_DETECTED" = "true" ]; then
            echo "::error::changes_detected should be false for empty dir only"
            exit 1
          fi
          if [ -n "$COMMIT_SHA" ]; then
            echo "::error::Commit SHA should be empty when no commit is created"
            exit 1
          fi
          echo "✅ No commit created for empty directory"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.branch.outputs.branch }}

  test-ignored-file-only:
    name: Test Ignored File Only (should NOT commit)
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Branch
        id: branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/ignored-file-only/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Configure Local Ignore + Create Ignored File
        shell: bash
        env:
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          set -euo pipefail

          mkdir -p ignored
          IGNORED_FILE="ignored/only-${TEST_ID}.txt"

          # Ensure local exclude file exists and ignore just this test file
          mkdir -p .git/info
          echo "$IGNORED_FILE" >> .git/info/exclude

          # Create the ignored file
          echo "IGNORED=1" > "$IGNORED_FILE"

          git check-ignore -q "$IGNORED_FILE"

      - name: Run commit-changes (should not commit)
        id: commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: ignored file only ${{ env.TEST_ID }}'
          file_pattern: '.'
          empty: 'false'

      - name: Verify No Commit
        shell: bash
        env:
          COMMIT_SHA: ${{ steps.commit.outputs.commit_hash }}
          CHANGES_DETECTED: ${{ steps.commit.outputs.changes_detected }}
        run: |
          if [ "$CHANGES_DETECTED" = "true" ]; then
            echo "::error::changes_detected should be false for ignored file only"
            exit 1
          fi
          if [ -n "$COMMIT_SHA" ]; then
            echo "::error::Commit SHA should be empty when no commit is created"
            exit 1
          fi
          echo "✅ No commit created for ignored-only changes"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.branch.outputs.branch }}

  test-pattern-mismatch:
    name: Test Pattern Mismatch (changes exist but pattern excludes them)
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Branch
        id: branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/pattern-mismatch/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Create a Change Outside the Pattern
        env:
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          mkdir -p mismatch
          echo "change $TEST_ID" > mismatch/outside.txt

      - name: Run commit-changes with non-matching pattern
        id: commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: pattern mismatch ${{ env.TEST_ID }}'
          file_pattern: 'does-not-exist/**/*.txt'
          empty: 'false'

      - name: Verify No Commit
        shell: bash
        env:
          COMMIT_SHA: ${{ steps.commit.outputs.commit_hash }}
          CHANGES_DETECTED: ${{ steps.commit.outputs.changes_detected }}
        run: |
          if [ "$CHANGES_DETECTED" = "true" ]; then
            echo "::error::changes_detected should be false when pattern matches nothing"
            exit 1
          fi
          if [ -n "$COMMIT_SHA" ]; then
            echo "::error::Commit SHA should be empty when no commit is created"
            exit 1
          fi
          echo "✅ No commit created when pattern mismatches"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.branch.outputs.branch }}

  test-file-pattern-relative-to-caller-dir:
    name: Test File Pattern Relative to Caller Subdirectory
    runs-on: ubuntu-latest

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Test Branch
        id: branch
        uses: TimSchoenle/actions/actions/common/create-branch@331de547737ea4a2b899287998f1ff90a912b7ba # actions-common-create-branch-v1.2.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/file-pattern-relative/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Create Test Files (inside caller subdir)
        shell: bash
        env:
          TEST_ID: ${{ env.TEST_ID }}
        run: |
          set -euo pipefail

          mkdir -p dist src/generated
          echo "dist file $TEST_ID" > dist/relative-dist.txt
          echo "generated file $TEST_ID" > src/generated/relative-gen.txt

      - name: Run commit-changes (patterns are relative to caller dir)
        id: commit
        uses: ./tmp/actions-code/actions/common/commit-changes
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: ${{ steps.branch.outputs.branch }}
          commit_message: 'test: relative patterns ${{ env.TEST_ID }}'
          file_pattern: 'dist/**/* src/generated/**/*'

      - name: Verify Commit Includes Prefixed Paths
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          COMMIT_SHA: ${{ steps.commit.outputs.commit_hash }}
          TEST_REPO: ${{ env.TEST_REPO }}
        run: |
          set -euo pipefail

          if [ -z "$COMMIT_SHA" ]; then
            echo "::error::Commit SHA not found in output"
            exit 1
          fi

          FILES=$(gh api "/repos/$TEST_REPO/commits/$COMMIT_SHA" --jq '.files[].filename' | sort || true)

          EXPECTED_1="workflows/common/test2/dist/relative-dist.txt"
          EXPECTED_2="workflows/common/test2/src/generated/relative-gen.txt"

          echo "Files in commit:"
          echo "$FILES"

          echo "$FILES" | grep -Fxq "$EXPECTED_1" || { echo "::error::Missing expected file: $EXPECTED_1"; exit 1; }
          echo "$FILES" | grep -Fxq "$EXPECTED_2" || { echo "::error::Missing expected file: $EXPECTED_2"; exit 1; }

          echo "✅ Relative patterns were correctly resolved against caller subdirectory"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: ${{ steps.branch.outputs.branch }}
