name: Verify Action Common Modify YAML

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'actions/common/modify-yaml/**'
      - '.github/workflows/verify-action-common-modify-yaml.yaml'

jobs:
  verify-modify-yaml:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: 'Modify Root Key'
            key: 'version'
            value: '2.0.0'
            check_grep: 'version: 2.0.0'

          - name: 'Modify Nested Key (3 levels)'
            key: 'app.database.primary.host'
            value: 'db.internal'
            check_grep: 'host: db.internal'

          - name: 'Modify Boolean False'
            key: 'app.debug'
            value: 'false'
            check_grep: 'debug: false'

          - name: 'Modify Boolean True'
            key: 'app.debug'
            value: 'true'
            check_grep: 'debug: true'

          - name: 'Modify Integer'
            key: 'app.database.primary.port'
            value: '3306'
            check_grep: 'port: 3306'

          - name: 'Modify Float'
            key: 'app.resources.cpu_ratio'
            value: '2.5'
            check_grep: 'cpu_ratio: 2.5'

          - name: 'Preserve Inline Comment'
            key: 'app.name'
            value: 'updated-app'
            check_grep: 'name: updated-app  # inline comment'

          - name: 'Preserve Comments'
            key: 'app.name'
            value: 'new-name'
            # Check value AND ensure comment still exists
            check_grep: 'name: new-name  # inline comment'

          - name: 'Deep Nesting (5 levels)'
            key: 'app.database.primary.credentials.options.timeout'
            value: '60'
            check_grep: 'timeout: 60'

          - name: 'Weird Indentation'
            key: 'config.deeply.nested.value'
            value: 'modified'
            check_grep: 'value: modified'

          - name: 'Similar Key Names'
            key: 'api.api_key'
            value: 'new-secret'
            check_grep: 'api_key: new-secret'

          - name: 'Value with Unit'
            key: 'app.resources.memory'
            value: '1024Mi'
            check_grep: 'memory: 1024Mi'

          - name: 'Duplicate Key Names (Different Parents)'
            key: 'app.database.primary.host'
            value: 'primary-changed'
            check_grep: 'host: primary-changed'
            # CRITICAL: Ensure secondary.host is NOT modified
            verify_unchanged: 'secondary:\s+host: backup-db'

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          persist-credentials: false

      - name: Setup Complex Test Data
        run: |
          cat <<EOF > complex.yaml
          # Top-level comment with special chars: @#$%
          version: 1.0.0

          # Application Metadata
          app:
            name: test-app # inline comment
            debug: true
            enabled: false  # another inline comment
            
            
            # Database Configuration (multiple blank lines above)
            database:
              primary:
                host: localhost
                port: 5432  # default postgres port
                credentials:
                  username: admin
                  password: secret123
                  # Nested config
                  options:
                    timeout: 30
                    retry: 3
                    connection:
                      pool:
                        min: 5  # minimum connections
                        max: 20
              
              # Secondary database
              secondary:
                host: backup-db
                port: 5433
            
            # Resource limits
            resources:
              cpu_ratio: 1.0
              memory: 512Mi  # with unit
              limits:
                cpu: 500m
                memory: 1Gi

          # Feature flags
          features:
            feature-a: true
            feature-b: false  # disabled for now
            feature-c: true

          # Arrays section
          tags:
            - production
            - critical
            - backend

          # Varied indentation (weird but valid)
          config:
              deeply:   # 6 spaces indent
                  nested:  # 10 spaces
                      value: test
                      another: data

          # Keys with similar names
          api:
            endpoint: https://api.example.com
            api_key: secret
            api_version: v2

          # Numbers and strings
          ports:
            http: 80
            https: 443
            custom: 8080
          EOF

      - name: Capture Pre-Modification State
        id: before
        run: |
          # Count blank lines
          BLANK_LINES=$(grep -c '^$' complex.yaml || echo "0")
          echo "blank-lines=$BLANK_LINES" >> "$GITHUB_OUTPUT"

          # Count total lines
          TOTAL_LINES=$(wc -l < complex.yaml)
          echo "total-lines=$TOTAL_LINES" >> "$GITHUB_OUTPUT"

          # Check comments exist
          grep -q "# Application Metadata" complex.yaml && echo "has-app-comment=true" >> "$GITHUB_OUTPUT" || echo "has-app-comment=false" >> "$GITHUB_OUTPUT"
          grep -q "# Database Configuration" complex.yaml && echo "has-db-comment=true" >> "$GITHUB_OUTPUT" || echo "has-db-comment=false" >> "$GITHUB_OUTPUT"
          grep -q "# inline comment" complex.yaml && echo "has-inline-comment=true" >> "$GITHUB_OUTPUT" || echo "has-inline-comment=false" >> "$GITHUB_OUTPUT"

          # Check indentation exists
          grep -q '^    host:' complex.yaml && echo "has-indent=true" >> "$GITHUB_OUTPUT" || echo "has-indent=false" >> "$GITHUB_OUTPUT"

          echo "üìä Pre-modification state:"
          echo "  Blank lines: $BLANK_LINES"
          echo "  Total lines: $TOTAL_LINES"

      - name: Run Test (${{ matrix.name }})
        id: modify
        uses: ./actions/common/modify-yaml
        with:
          file: complex.yaml
          key: ${{ matrix.key }}
          value: ${{ matrix.value }}

      - name: Assert Change
        env:
          CHECK_GREP: ${{ matrix.check_grep }}
          VERIFY_UNCHANGED: ${{ matrix.verify_unchanged || '' }}
        run: |
          # Verify the file content matches expectations
          if ! grep -q "$CHECK_GREP" complex.yaml; then
            echo "::error::Match not found for pattern: $CHECK_GREP"
            cat complex.yaml
            exit 1
          fi

          echo "‚úÖ Value change verified"

          # Check that other values weren't accidentally modified
          if [ -n "$VERIFY_UNCHANGED" ]; then
            if ! grep -Pzo "$VERIFY_UNCHANGED" complex.yaml > /dev/null; then
              echo "::error::Verification failed - another value was incorrectly modified!"
              echo "Expected to find unchanged: $VERIFY_UNCHANGED"
              cat complex.yaml
              exit 1
            fi
            echo "‚úÖ Other duplicate keys verified unchanged"
          fi

      - name: Verify Formatting Preservation
        env:
          HAS_APP_COMMENT: ${{ steps.before.outputs.has-app-comment }}
          HAS_DB_COMMENT: ${{ steps.before.outputs.has-db-comment }}
          HAS_INLINE_COMMENT: ${{ steps.before.outputs.has-inline-comment }}
          HAS_INDENT: ${{ steps.before.outputs.has-indent }}
          BEFORE_BLANK_LINES: ${{ steps.before.outputs.blank-lines }}
          BEFORE_TOTAL_LINES: ${{ steps.before.outputs.total-lines }}
          MATRIX_NAME: ${{ matrix.name }}
        run: |
          echo "üîç Verifying preservation..."

          # 1. Check all comments still present (if they were before)
          if [ "$HAS_APP_COMMENT" == "true" ]; then
            if ! grep -q "# Application Metadata" complex.yaml; then
              echo "::error::Block comment 'Application Metadata' was removed!"
              exit 1
            fi
          fi

          if [ "$HAS_DB_COMMENT" == "true" ]; then
            if ! grep -q "# Database Configuration" complex.yaml; then
              echo "::error::Block comment 'Database Configuration' was removed!"
              exit 1
            fi
          fi

          if [ "$HAS_INLINE_COMMENT" == "true" ]; then
            if ! grep -q "# inline comment" complex.yaml; then
              echo "::error::Inline comment was removed!"
              exit 1
            fi
          fi

          echo "‚úÖ All comments preserved"

          # 2. Check blank lines preserved (same count as before)
          BLANK_LINES_AFTER=$(grep -c '^$' complex.yaml || echo "0")
          if [ "$BLANK_LINES_AFTER" -ne "$BEFORE_BLANK_LINES" ]; then
            echo "::error::Blank line count changed! Before: $BEFORE_BLANK_LINES, After: $BLANK_LINES_AFTER"
            exit 1
          fi
          echo "‚úÖ Blank lines preserved ($BLANK_LINES_AFTER)"

          # 3. Check indentation preserved (if it was there before)
          if [ "$HAS_INDENT" == "true" ]; then
            if ! grep -q '^    host:' complex.yaml; then
              echo "::error::Indentation was changed!"
              exit 1
            fi
          fi
          echo "‚úÖ Indentation preserved"

          # 4. Check total line count (should be same, we only modify values)
          TOTAL_LINES_AFTER=$(wc -l < complex.yaml)
          if [ "$TOTAL_LINES_AFTER" -ne "$BEFORE_TOTAL_LINES" ]; then
            echo "::error::Line count changed! Before: $BEFORE_TOTAL_LINES, After: $TOTAL_LINES_AFTER"
            exit 1
          fi
          echo "‚úÖ Total lines preserved ($TOTAL_LINES_AFTER)"

          # Special check for inline comment spacing (only for that specific test)
          if [ "$MATRIX_NAME" == "Preserve Inline Comment" ]; then
            if ! grep -E 'name: updated-app\s+# inline comment' complex.yaml; then
              echo "::error::Inline comment spacing not preserved!"
              cat complex.yaml | grep "name:"
              exit 1
            fi
            echo "‚úÖ Inline comment spacing preserved"
          fi

          echo "‚úÖ All formatting preservation checks passed!"
