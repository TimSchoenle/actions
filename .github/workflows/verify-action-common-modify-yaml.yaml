name: Verify Action Common Modify YAML

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'actions/common/modify-yaml/**'
      - '.github/workflows/verify-action-common-modify-yaml.yaml'

jobs:
  verify-modify-yaml:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: 'Modify Root Key'
            key: 'version'
            value: '2.0.0'
            check_grep: 'version: 2.0.0'
          
          - name: 'Modify Nested Key'
            key: 'app.database.host'
            value: 'db.internal'
            check_grep: 'host: db.internal'

          - name: 'Modify Boolean False'
            key: 'app.debug'
            value: 'false'
            check_grep: 'debug: false'

          - name: 'Modify Boolean True'
            key: 'app.debug'
            value: 'true'
            check_grep: 'debug: true'

          - name: 'Modify Integer'
            key: 'app.database.port'
            value: '3306'
            check_grep: 'port: 3306'

          - name: 'Modify Float'
            key: 'app.resources.cpu_ratio'
            value: '2.5'
            check_grep: 'cpu_ratio: 2.5'

          - name: 'Preserve Comments'
            key: 'app.name'
            value: 'new-name'
            # Check value AND ensure comment still exists
            check_grep: 'name: new-name.*inline comment' 

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Complex Test Data
        run: |
          cat <<EOF > complex.yaml
          version: 1.0.0
          
          # Application Metadata
          app:
            name: test-app # inline comment
            debug: true
            
            # Database Configuration
            database:
              host: localhost
              port: 5432
            resources:
              cpu_ratio: 1.0
              limits:
                cpu: 500m432
          EOF

      - name: Run Test (${{ matrix.name }})
        id: modify
        uses: ./actions/common/modify-yaml
        with:
          file: complex.yaml
          key: ${{ matrix.key }}
          value: ${{ matrix.value }}

      - name: Assert Change
        run: |
          # Verify the file content matches expectations
          if ! grep -q "${{ matrix.check_grep }}" complex.yaml; then
            echo "::error::Match not found for pattern: ${{ matrix.check_grep }}"
            cat complex.yaml
            exit 1
          fi
          
          echo "✅ Value change verified"
      
      - name: Verify Formatting Preservation
        run: |
          # 1. Check all comments preserved
          echo "Checking comment preservation..."
          
          if ! grep -q "# Application Metadata" complex.yaml; then
            echo "::error::Block comment 'Application Metadata' lost!"
            exit 1
          fi
          
          if ! grep -q "# Database Configuration" complex.yaml; then
            echo "::error::Block comment 'Database Configuration' lost!"
            exit 1
          fi
          
          if ! grep -q "# inline comment" complex.yaml; then
            echo "::error::Inline comment lost!"
            exit 1
          fi
          
          echo "✅ All comments preserved"
          
          # 2. Check blank lines preserved
          echo "Checking blank line preservation..."
          BLANK_LINES=$(grep -c '^$' complex.yaml || true)
          if [ "$BLANK_LINES" -lt 2 ]; then
            echo "::error::Blank lines were removed! Found: $BLANK_LINES"
            exit 1
          fi
          echo "✅ Blank lines preserved ($BLANK_LINES found)"
          
          # 3. Check indentation preserved  
          echo "Checking indentation..."
          if ! grep -q '^    host:' complex.yaml; then
            echo "::error::Indentation changed for nested values!"
            exit 1
          fi
          echo "✅ Indentation preserved"
          
          # 4. Count total lines changed
          # For most test cases, ONLY 1 line should change
          EXPECTED_CHANGES=1
          
          # Exception: preserve comments test modifies a line that has a comment
          if [ "${{ matrix.name }}" == "Preserve Comments" ]; then
            EXPECTED_CHANGES=1
          fi
          
          echo "✅ All formatting preservation checks passed!"
