name: Verify Action Common Modify YAML

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'actions/common/modify-yaml/**'
      - '.github/workflows/verify-action-common-modify-yaml.yaml'

jobs:
  verify-modify-yaml:
    permissions:
      contents: read
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: 'Modify Root Key'
            key: 'version'
            value: '2.0.0'
            check_grep: 'version: 2.0.0'
          
          - name: 'Modify Nested Key'
            key: 'app.database.host'
            value: 'db.internal'
            check_grep: 'host: db.internal'

          - name: 'Modify Boolean False'
            key: 'app.debug'
            value: 'false'
            check_grep: 'debug: false'

          - name: 'Modify Boolean True'
            key: 'app.debug'
            value: 'true'
            check_grep: 'debug: true'

          - name: 'Modify Integer'
            key: 'app.database.port'
            value: '3306'
            check_grep: 'port: 3306'

          - name: 'Modify Float'
            key: 'app.resources.cpu_ratio'
            value: '2.5'
            check_grep: 'cpu_ratio: 2.5'
          
          - name: 'Preserve Inline Comment'
            key: 'app.name'
            value: 'updated-app'
            check_grep: 'name: updated-app # inline comment'

          - name: 'Preserve Comments'
            key: 'app.name'
            value: 'new-name'
            # Check value AND ensure comment still exists
            check_grep: 'name: new-name.*inline comment' 

    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Setup Complex Test Data
        run: |
          cat <<EOF > complex.yaml
          version: 1.0.0
          
          # Application Metadata
          app:
            name: test-app # inline comment
            debug: true
            
            # Database Configuration
            database:
              host: localhost
              port: 5432
            resources:
              cpu_ratio: 1.0
              limits:
                cpu: 500m
          EOF

      - name: Capture Pre-Modification State
        id: before
        run: |
          # Count blank lines
          BLANK_LINES=$(grep -c '^$' complex.yaml || echo "0")
          echo "blank-lines=$BLANK_LINES" >> "$GITHUB_OUTPUT"
          
          # Count total lines
          TOTAL_LINES=$(wc -l < complex.yaml)
          echo "total-lines=$TOTAL_LINES" >> "$GITHUB_OUTPUT"
          
          # Check comments exist
          grep -q "# Application Metadata" complex.yaml && echo "has-app-comment=true" >> "$GITHUB_OUTPUT" || echo "has-app-comment=false" >> "$GITHUB_OUTPUT"
          grep -q "# Database Configuration" complex.yaml && echo "has-db-comment=true" >> "$GITHUB_OUTPUT" || echo "has-db-comment=false" >> "$GITHUB_OUTPUT"
          grep -q "# inline comment" complex.yaml && echo "has-inline-comment=true" >> "$GITHUB_OUTPUT" || echo "has-inline-comment=false" >> "$GITHUB_OUTPUT"
          
          # Check indentation exists
          grep -q '^    host:' complex.yaml && echo "has-indent=true" >> "$GITHUB_OUTPUT" || echo "has-indent=false" >> "$GITHUB_OUTPUT"
          
          echo "üìä Pre-modification state:"
          echo "  Blank lines: $BLANK_LINES"
          echo "  Total lines: $TOTAL_LINES"

      - name: Run Test (${{ matrix.name }})
        id: modify
        uses: ./actions/common/modify-yaml
        with:
          file: complex.yaml
          key: ${{ matrix.key }}
          value: ${{ matrix.value }}

      - name: Assert Change
        run: |
          # Verify the file content matches expectations
          if ! grep -q "${{ matrix.check_grep }}" complex.yaml; then
            echo "::error::Match not found for pattern: ${{ matrix.check_grep }}"
            cat complex.yaml
            exit 1
          fi
          
          echo "‚úÖ Value change verified"
      
      - name: Verify Formatting Preservation
        run: |
          echo "üîç Verifying preservation..."
          
          # 1. Check all comments still present (if they were before)
          if [ "${{ steps.before.outputs.has-app-comment }}" == "true" ]; then
            if ! grep -q "# Application Metadata" complex.yaml; then
              echo "::error::Block comment 'Application Metadata' was removed!"
              exit 1
            fi
          fi
          
          if [ "${{ steps.before.outputs.has-db-comment }}" == "true" ]; then
            if ! grep -q "# Database Configuration" complex.yaml; then
              echo "::error::Block comment 'Database Configuration' was removed!"
              exit 1
            fi
          fi
          
          if [ "${{ steps.before.outputs.has-inline-comment }}" == "true" ]; then
            if ! grep -q "# inline comment" complex.yaml; then
              echo "::error::Inline comment was removed!"
              exit 1
            fi
          fi
          
          echo "‚úÖ All comments preserved"
          
          # 2. Check blank lines preserved (same count as before)
          BLANK_LINES_AFTER=$(grep -c '^$' complex.yaml || echo "0")
          if [ "$BLANK_LINES_AFTER" -ne "${{ steps.before.outputs.blank-lines }}" ]; then
            echo "::error::Blank line count changed! Before: ${{ steps.before.outputs.blank-lines }}, After: $BLANK_LINES_AFTER"
            exit 1
          fi
          echo "‚úÖ Blank lines preserved ($BLANK_LINES_AFTER)"
          
          # 3. Check indentation preserved (if it was there before)
          if [ "${{ steps.before.outputs.has-indent }}" == "true" ]; then
            if ! grep -q '^    host:' complex.yaml; then
              echo "::error::Indentation was changed!"
              exit 1
            fi
          fi
          echo "‚úÖ Indentation preserved"
          
          # 4. Check total line count (should be same, we only modify values)
          TOTAL_LINES_AFTER=$(wc -l < complex.yaml)
          if [ "$TOTAL_LINES_AFTER" -ne "${{ steps.before.outputs.total-lines }}" ]; then
            echo "::error::Line count changed! Before: ${{ steps.before.outputs.total-lines }}, After: $TOTAL_LINES_AFTER"
            exit 1
          fi
          echo "‚úÖ Total lines preserved ($TOTAL_LINES_AFTER)"
          
          # Special check for inline comment spacing (only for that specific test)
          if [ "${{ matrix.name }}" == "Preserve Inline Comment" ]; then
            if ! grep -E 'name: updated-app\s+# inline comment' complex.yaml; then
              echo "::error::Inline comment spacing not preserved!"
              cat complex.yaml | grep "name:"
              exit 1
            fi
            echo "‚úÖ Inline comment spacing preserved"
          fi
          
          echo "‚úÖ All formatting preservation checks passed!"
