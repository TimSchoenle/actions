name: 'Auto-Approve & Merge Timed PRs'
description: 'Reusable workflow that automatically verifies, approves, and merges Pull Requests that match a specific branch pattern and have been open for a configurable duration. It ensures all commits are signed and authored by trusted users.'

on:
  workflow_call:
    inputs:
      time_elapsed:
        description: 'Time elapsed since PR creation (e.g. "24h", "1d").'
        required: true
        type: string
        default: '1d'
      branch_pattern:
        description: 'Pattern to match branch names (e.g. "release-please--branches--%").'
        required: true
        type: string
        default: 'release-please--branches--%'
      trusted_authors:
        description: 'Comma-separated list of Database IDs of accepted authors.'
        required: true
        type: string
    secrets:
      token:
        description: 'GitHub Token with permission to manage PRs.'
        required: true

permissions: {}

jobs:
  prepare-matrix:
    name: Find PRs
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Find PRs
        id: set-matrix
        env:
          GH_TOKEN: ${{ secrets.token }}
          TIME_ELAPSED: ${{ inputs.time_elapsed }}
          BRANCH_PATTERN: ${{ inputs.branch_pattern }}
        run: |
          # Normalize time format: 1d -> 1 day, 24h -> 24 hour (GNU date requires words)          
          NORMALIZED_TIME=$(echo "$TIME_ELAPSED" | sed -E 's/([0-9]+)d/\1 days/; s/([0-9]+)h/\1 hours/; s/([0-9]+)m/\1 minutes/; s/([0-9]+)s/\1 seconds/')
          echo "Normalized time: '$NORMALIZED_TIME'"

          # Calculate cutoff date in UTC
          # ubuntu-latest uses GNU date
          CUTOFF_DATE=$(date -u -d "$NORMALIZED_TIME ago" +%Y-%m-%dT%H:%M:%SZ)
          echo "Cutoff: $CUTOFF_DATE"

          # gh pr list filters
          # map % to .* and anchor to start (^)
          PRS=$(gh pr list \
            --repo "${{ github.repository }}" \
            --state open \
            --json number,url,headRefName,createdAt \
            --jq "map(select(.headRefName | test(\"^${BRANCH_PATTERN//%/.*}\"))) | map(select(.createdAt < \"$CUTOFF_DATE\"))")

          echo "Found PRs: $PRS"

          # Create matrix include structure
          MATRIX=$(echo "$PRS" | jq -c 'if length > 0 then {include: .} else {include: []} end')
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  process-pr:
    name: Process PR #${{ matrix.number }}
    needs: prepare-matrix
    if: ${{ fromJson(needs.prepare-matrix.outputs.matrix).include[0] != null }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Verify Commits
        id: verify
        uses: TimSchoenle/actions/actions/helper/verify-commit-authors@2e1d6fbc0347a1c1cdc666b2b208a9125686bca6 # actions-helper-verify-commit-authors-v1.1.0
        with:
          pr_url: ${{ matrix.url }}
          github_token: ${{ secrets.token }}
          user_ids: ${{ inputs.trusted_authors }}

      - name: Approve and Auto-Merge
        if: steps.verify.outputs.verified == 'true'
        env:
          GH_TOKEN: ${{ secrets.token }}
          PR_URL: ${{ matrix.url }}
        run: |
          echo "PR verified. Approving..."
          gh pr review "$PR_URL" --approve --body "Auto-approved verified release PR."

          echo "Enabling auto-merge..."
          gh pr merge "$PR_URL" --auto --merge || echo "Failed to enable auto-merge (might be already enabled or not allowed)"
