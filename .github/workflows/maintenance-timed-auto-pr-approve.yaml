name: 'Auto-Approve & Merge Timed PRs'
description: 'Reusable workflow that automatically verifies, approves, and merges Pull Requests that match a specific branch pattern and have been open for a configurable duration. It ensures all commits are signed and authored by trusted users.'

on:
  workflow_call:
    inputs:
      time_elapsed:
        description: 'Time elapsed since PR creation (e.g. "24h", "1d").'
        required: false
        type: string
        default: '1d'
      branch_pattern:
        description: 'Pattern to match branch names (e.g. "release-please--branches--%").'
        required: false
        type: string
        default: 'release-please--branches--%'
      merge_method:
        description: 'Merge method to use (merge, squash, rebase).'
        required: false
        type: string
        default: 'squash'
      trusted_authors:
        description: 'Comma-separated list of Database IDs of accepted authors.'
        required: true
        type: string
    secrets:
      app_id:
        description: 'GitHub App ID with permissions to write contents and pull requests.'
        required: true
      private_key:
        description: 'GitHub App Private Key'
        required: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  prepare-matrix:
    name: Find PRs
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Generate Bot Token
        id: generate_token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        with:
          app-id: ${{ secrets.app_id }}
          private-key: ${{ secrets.private_key }}
          permission-contents: read
          permission-pull-requests: read

      - name: Find PRs
        id: set-matrix
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
          TIME_ELAPSED: ${{ inputs.time_elapsed }}
          BRANCH_PATTERN: ${{ inputs.branch_pattern }}
          GH_REPO: ${{ github.repository }}
        run: |
          # Normalize time format: 1d -> 1 day, 24h -> 24 hour (GNU date requires words)          
          NORMALIZED_TIME=$(echo "$TIME_ELAPSED" | sed -E 's/([0-9]+)d/\1 days/; s/([0-9]+)h/\1 hours/; s/([0-9]+)m/\1 minutes/; s/([0-9]+)s/\1 seconds/')
          echo "Normalized time: '$NORMALIZED_TIME'"

          # Calculate cutoff date in UTC
          # ubuntu-latest uses GNU date
          CUTOFF_DATE=$(date -u -d "$NORMALIZED_TIME ago" +%Y-%m-%dT%H:%M:%SZ)
          echo "Cutoff: $CUTOFF_DATE"

          # gh pr list filters
          # map % to .* and anchor to start (^)
          PRS=$(gh pr list \
            --repo "$GH_REPO" \
            --state open \
            --json number,url,headRefName,createdAt \
            --jq "map(select(.headRefName | test(\"^${BRANCH_PATTERN//%/.*}\"))) | map(select(.createdAt < \"$CUTOFF_DATE\"))")

          echo "Found PRs: $PRS"

          # Create matrix include structure
          MATRIX=$(echo "$PRS" | jq -c 'if length > 0 then {include: .} else {include: []} end')
          echo "matrix=$MATRIX" >> "$GITHUB_OUTPUT"

  process-pr:
    name: Process PR #${{ matrix.number }}
    needs: prepare-matrix
    if: ${{ fromJson(needs.prepare-matrix.outputs.matrix).include[0] != null }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: Generate Bot Token
        id: generate_token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2
        with:
          app-id: ${{ secrets.app_id }}
          private-key: ${{ secrets.private_key }}
          permission-contents: write
          permission-pull-requests: write

      - name: Verify Commits
        id: verify
        uses: TimSchoenle/actions/actions/helper/verify-commit-authors@0c26ac162a441046f6d88706c76566986d4fd8c5 # actions-helper-verify-commit-authors-v1.1.2
        with:
          pr_url: ${{ matrix.url }}
          github_token: ${{ steps.generate_token.outputs.token }}
          user_ids: ${{ inputs.trusted_authors }}

      - name: Approve and Auto-Merge
        if: steps.verify.outputs.verified == 'true'
        env:
          GH_TOKEN: ${{ steps.generate_token.outputs.token }}
          PR_URL: ${{ matrix.url }}
          MERGE_METHOD: ${{ inputs.merge_method }}
        run: |
          echo "PR verified. Approving..."
          gh pr review "$PR_URL" --approve --body "Auto-approved verified release PR."

          echo "Enabling auto-merge with method: $MERGE_METHOD..."
          gh pr merge "$PR_URL" --auto --"$MERGE_METHOD" || echo "Failed to enable auto-merge (might be already enabled or not allowed)"
