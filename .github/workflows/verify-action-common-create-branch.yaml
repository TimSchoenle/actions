name: Verify Common Create-branch

on:
  push:
    branches:
      - main
      - 'feature/actions/common/create-branch'
    paths:
      - 'actions/common/create-branch/**'
      - '.github/workflows/verify-action-common-create-branch.yaml'
  pull_request:
    paths:
      - 'actions/common/create-branch/**'
      - '.github/workflows/verify-action-common-create-branch.yaml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

env:
  TEST_OWNER: TimSchoenle
  TEST_REPO_NAME: actions-testing
  TEST_REPO: TimSchoenle/actions-testing
  TEST_ID: create-branch-test-${{ github.run_number }}-${{ github.run_attempt }}
  TEST_REPO_BASE_BRANCH_NAME: main

jobs:
  test-create-branch-default:
    name: Test Create Branch (Default Base)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Run create-branch
        id: create
        uses: ./tmp/actions-code/actions/common/create-branch
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/create-branch-default/${{ env.TEST_ID }}

      - name: Verify Branch Created
        shell: bash
        env:
          GH_TOKEN: ${{ steps.setup.outputs.token }}
          BRANCH_NAME: ${{ steps.create.outputs.branch }}
          BASE_BRANCH_NAME: ${{ steps.create.outputs.base_branch }}
          SHA: ${{ steps.create.outputs.sha }}
          CREATED: ${{ steps.create.outputs.created }}
          TEST_REPO: ${{ env.TEST_REPO }}
        run: |
          if [ "$CREATED" != "true" ]; then
            echo "::error::Branch should have been created"
            exit 1
          fi

          # Verify remote SHA
          REMOTE_SHA=$(gh api "/repos/$TEST_REPO/git/refs/heads/$BRANCH_NAME" --jq .object.sha)
          if [ "$REMOTE_SHA" != "$SHA" ]; then
             echo "::error::Remote SHA ($REMOTE_SHA) does not match output SHA ($SHA)"
             exit 1
          fi
          echo "✅ Verified branch created at $SHA"

      - name: Verify Base Branch Name
        shell: bash
        env:
          BASE_BRANCH_NAME: ${{ steps.create.outputs.base_branch }}
          EXPECTED_BASE_BRANCH_NAME: ${{ env.TEST_REPO_BASE_BRANCH_NAME }}
        run: |
          # Verify base branch name
          if [ "$BASE_BRANCH_NAME" != "$EXPECTED_BASE_BRANCH_NAME" ]; then
            echo "::error::Base branch name ($BASE_BRANCH_NAME) does not match default ($EXPECTED_BASE_BRANCH_NAME)"
            exit 1
          fi
          echo "✅ Verified base branch name matches"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/create-branch-default/${{ env.TEST_ID }}

  test-create-branch-specific-base:
    name: Test Create Branch (Specific Base)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      # We need a predictable base branch. Let's use 'main' explicitly, or create a 'base' branch first.
      # Let's create a 'base' branch first using the action (defaults to default branch).
      - name: Create Base Branch
        id: create-base
        uses: ./tmp/actions-code/actions/common/create-branch
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/base-branch/${{ env.TEST_ID }}

      - name: Run create-branch (From Specific Base)
        id: create-child
        uses: ./tmp/actions-code/actions/common/create-branch
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/child-branch/${{ env.TEST_ID }}
          base_branch: test/base-branch/${{ env.TEST_ID }}

      - name: Verify Child Branch
        shell: bash
        env:
          BASE_SHA: ${{ steps.create-base.outputs.sha }}
          CHILD_SHA: ${{ steps.create-child.outputs.sha }}
        run: |
          if [ "$CHILD_SHA" != "$BASE_SHA" ]; then
             echo "::error::Child branch SHA ($CHILD_SHA) does not match Base branch SHA ($BASE_SHA)"
             exit 1
          fi
          echo "✅ Verified child branch created from specific base"

      - name: Verify Base Branch Name
        shell: bash
        env:
          BASE_BRANCH_NAME: ${{ steps.create-child.outputs.base_branch }}
          EXPECTED_BASE_BRANCH_NAME: ${{ steps.create-base.outputs.branch }}
        run: |
          # Verify base branch name
          if [ "$BASE_BRANCH_NAME" != "$EXPECTED_BASE_BRANCH_NAME" ]; then
            echo "::error::Base branch name ($BASE_BRANCH_NAME) does not match default ($EXPECTED_BASE_BRANCH_NAME)"
            exit 1
          fi
          echo "✅ Verified base branch name matches"

      - name: Cleanup Child Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/child-branch/${{ env.TEST_ID }}

      - name: Cleanup Base Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/base-branch/${{ env.TEST_ID }}

  test-reset-branch:
    name: Test Reset Branch (Diverged)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Setup E2E Test Environment
        id: setup
        uses: TimSchoenle/actions/actions/test/setup-e2e@76797c82cebc42c5752553eb4608db7367ad89d6 # actions-test-setup-e2e-v1.1.0
        with:
          app_id: ${{ secrets.ACTIONS_TEST_BOT_APP_ID }}
          private_key: ${{ secrets.ACTIONS_TEST_BOT_PRIVATE_KEY }}
          test_owner: ${{ env.TEST_OWNER }}
          test_repo: ${{ env.TEST_REPO }}
          test_repo_name: ${{ env.TEST_REPO_NAME }}
          current_repo_checkout_path: 'tmp/actions-code'

      - name: Create Initial Branch
        id: create-initial
        uses: ./tmp/actions-code/actions/common/create-branch
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/reset-branch/${{ env.TEST_ID }}

      - name: Create Test File for Commit
        run: |
          mkdir -p test-data
          echo "Diverging commit for $TEST_ID" > test-data/diverge.txt

      - name: Commit Changes (Diverge)
        id: commit-diverge
        uses: TimSchoenle/actions/actions/common/commit-changes@ccb733de0fa5b01dc39863828392f7fcf76927f0 # actions-common-commit-changes-v1.1.2
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch: test/reset-branch/${{ env.TEST_ID }}
          commit_message: 'test: diverge branch for reset test'
          file_pattern: 'test-data/diverge.txt'

      - name: Verify Divergence
        shell: bash
        env:
          INITIAL_SHA: ${{ steps.create-initial.outputs.sha }}
          DIVERGED_SHA: ${{ steps.commit-diverge.outputs.commit_hash }}
        run: |
          if [ "$INITIAL_SHA" == "$DIVERGED_SHA" ]; then
            echo "::error::Branch failed to diverge"
            exit 1
          fi
          echo "✅ Branch diverged: $INITIAL_SHA -> $DIVERGED_SHA"

      - name: Try Create Branch (No Reset)
        id: create-no-reset
        uses: ./tmp/actions-code/actions/common/create-branch
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/reset-branch/${{ env.TEST_ID }}
          reset_branch: 'false'

      - name: Verify No Reset
        shell: bash
        env:
          DIVERGED_SHA: ${{ steps.commit-diverge.outputs.commit_hash }}
          CURRENT_SHA: ${{ steps.create-no-reset.outputs.sha }}
          CREATED: ${{ steps.create-no-reset.outputs.created }}
        run: |
          if [ "$CREATED" == "true" ]; then
            echo "::error::Branch reported as created/reset even though reset_branch=false"
            exit 1
          fi
          if [ "$CURRENT_SHA" != "$DIVERGED_SHA" ]; then
             echo "::error::Branch SHA changed! Expected $DIVERGED_SHA, got $CURRENT_SHA"
             exit 1
          fi
          echo "✅ Verified branch was NOT reset"

      - name: Verify Base Branch Name
        shell: bash
        env:
          BASE_BRANCH_NAME: ${{ steps.create-no-reset.outputs.base_branch }}
          EXPECTED_BASE_BRANCH_NAME: ${{ env.TEST_REPO_BASE_BRANCH_NAME }}
        run: |
          # Verify base branch name
          if [ "$BASE_BRANCH_NAME" != "$EXPECTED_BASE_BRANCH_NAME" ]; then
            echo "::error::Base branch name ($BASE_BRANCH_NAME) does not match default ($EXPECTED_BASE_BRANCH_NAME)"
            exit 1
          fi
          echo "✅ Verified base branch name matches"

      - name: Reset Branch (Force)
        id: create-reset
        uses: ./tmp/actions-code/actions/common/create-branch
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/reset-branch/${{ env.TEST_ID }}
          reset_branch: 'true'

      - name: Verify Reset
        shell: bash
        env:
          INITIAL_SHA: ${{ steps.create-initial.outputs.sha }}
          RESET_SHA: ${{ steps.create-reset.outputs.sha }}
          CREATED: ${{ steps.create-reset.outputs.created }}
        run: |
          if [ "$CREATED" != "true" ]; then
            echo "::error::Branch should have been reset"
            exit 1
          fi
          if [ "$RESET_SHA" != "$INITIAL_SHA" ]; then
             echo "::error::Branch reset to wrong SHA! Expected $INITIAL_SHA, got $RESET_SHA"
             exit 1
          fi
          echo "✅ Verified branch RESET to initial SHA (divergence discarded)"

      - name: Verify Base Branch Name
        shell: bash
        env:
          BASE_BRANCH_NAME: ${{ steps.create-reset.outputs.base_branch }}
          EXPECTED_BASE_BRANCH_NAME: ${{ env.TEST_REPO_BASE_BRANCH_NAME }}
        run: |
          # Verify base branch name
          if [ "$BASE_BRANCH_NAME" != "$EXPECTED_BASE_BRANCH_NAME" ]; then
            echo "::error::Base branch name ($BASE_BRANCH_NAME) does not match default ($EXPECTED_BASE_BRANCH_NAME)"
            exit 1
          fi
          echo "✅ Verified base branch name matches"

      - name: Cleanup Branch
        if: always()
        uses: TimSchoenle/actions/actions/common/delete-branch@8001f0d144c85586ba753315fb37a5c8237cfa99 # actions-common-delete-branch-v1.1.0
        with:
          token: ${{ steps.setup.outputs.token }}
          repository: ${{ env.TEST_REPO }}
          branch_name: test/reset-branch/${{ env.TEST_ID }}
